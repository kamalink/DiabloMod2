// --- –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† –ù–ê–í–´–ö–û–í ---

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–µ—Ä–µ–≤–∞
window.skillTreeState = {
    scale: 1,
    panning: false,
    pointX: 0, pointY: 0,
    startX: 0, startY: 0,
    translateX: 0, translateY: 0,
    currentClass: null
};

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ä–∞—Å–∫–ª–∞–¥–æ–∫ (–∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ LocalStorage –µ—Å–ª–∏ –µ—Å—Ç—å)
window.customSkillLayouts = JSON.parse(localStorage.getItem('d3mod_skill_layouts') || '{}');
window.isSkillTreeEditing = false;

window.openSkillCalculator = function() {
    const modal = document.getElementById('skill-calc-modal');
    const classSelectContainer = document.getElementById('calc-class-selector-container');
    const classSelect = document.getElementById('calc-class-select');
    
    // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
    window.skillTreeState.scale = 1;
    window.skillTreeState.translateX = 0;
    window.skillTreeState.translateY = 0;
    window.updateTreeTransform();

    const playerClass = window.playerData.className;

        // 1. –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–ª–∞—Å—Å–∞
    if (playerClass && window.skillDB[playerClass] && playerClass !== "–ö–ª–∞—Å—Å –Ω–µ –≤—ã–±—Ä–∞–Ω") {
        // –ï—Å–ª–∏ –∫–ª–∞—Å—Å –≤—ã–±—Ä–∞–Ω, —Å–∫—Ä—ã–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –∏ —Å—Ä–∞–∑—É –≥—Ä—É–∑–∏–º –¥–µ—Ä–µ–≤–æ
        classSelectContainer.style.display = 'none';
        window.initSkillTree(playerClass);
    } else {
        // –ï—Å–ª–∏ –∫–ª–∞—Å—Å –Ω–µ –≤—ã–±—Ä–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä
        classSelectContainer.style.display = 'block';
        classSelect.innerHTML = '';
        classSelect.innerHTML = '<option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</option>';
        for (let cls in window.skillDB) {
            classSelect.innerHTML += `<option value="${cls}">${cls}</option>`;
        }
         // –û—á–∏—â–∞–µ–º –¥–µ—Ä–µ–≤–æ –ø–æ–∫–∞ –Ω–µ –≤—ã–±–µ—Ä—É—Ç
        document.getElementById('skill-tree-content').innerHTML = '<div style="color:#888; position:absolute; transform:translate(-50%, -50%); text-align:center;">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å<br>–≤ –º–µ–Ω—é —Å–ø—Ä–∞–≤–∞</div>';
    }
    
      modal.style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –º—ã—à–∏ –¥–ª—è –¥–µ—Ä–µ–≤–∞ (–æ–¥–∏–Ω —Ä–∞–∑)
    if (!window.skillTreeEventsInitialized) {
        const viewport = document.getElementById('skill-tree-viewport');
        
        viewport.addEventListener('mousedown', (e) => {
            window.skillTreeState.panning = true;
            window.skillTreeState.startX = e.clientX - window.skillTreeState.translateX;
            window.skillTreeState.startY = e.clientY - window.skillTreeState.translateY;
            viewport.style.cursor = 'grabbing';
        });

        window.addEventListener('mousemove', (e) => {
            if (!window.skillTreeState.panning) return;
            e.preventDefault();
            window.skillTreeState.translateX = e.clientX - window.skillTreeState.startX;
            window.skillTreeState.translateY = e.clientY - window.skillTreeState.startY;
            window.updateTreeTransform();
        });

        window.addEventListener('mouseup', () => {
            window.skillTreeState.panning = false;
            viewport.style.cursor = 'grab';
        });

        viewport.addEventListener('wheel', (e) => {
            e.preventDefault();
            const xs = (e.clientX - viewport.getBoundingClientRect().left - window.skillTreeState.translateX) / window.skillTreeState.scale;
            const ys = (e.clientY - viewport.getBoundingClientRect().top - window.skillTreeState.translateY) / window.skillTreeState.scale;
            
            const delta = -Math.sign(e.deltaY) * 0.1;
            const newScale = Math.min(Math.max(0.5, window.skillTreeState.scale + delta), 3);
            
            window.skillTreeState.translateX -= xs * (newScale - window.skillTreeState.scale);
            window.skillTreeState.translateY -= ys * (newScale - window.skillTreeState.scale);
            window.skillTreeState.scale = newScale;
            
            window.updateTreeTransform();
        });
        
        window.skillTreeEventsInitialized = true;
    }
}

window.updateTreeTransform = function() {
    const content = document.getElementById('skill-tree-content');
    content.style.transform = `translate(${window.skillTreeState.translateX}px, ${window.skillTreeState.translateY}px) scale(${window.skillTreeState.scale})`;
}

window.resetTreeCamera = function() {
    window.skillTreeState.scale = 1;
    window.skillTreeState.translateX = 0;
    window.skillTreeState.translateY = 0;
    window.updateTreeTransform();
}

window.initSkillTree = function(className) {
    if (!className || !window.skillDB[className]) return;
    window.skillTreeState.currentClass = className;
    const container = document.getElementById('skill-tree-content');
    container.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–º—ã
    const viewport = document.getElementById('skill-tree-viewport');
    viewport.className = 'skill-tree-viewport'; // –°–±—Ä–æ—Å
    const themeMap = {
        "–í–∞—Ä–≤–∞—Ä": "tree-theme-barbarian",
        "–ú–æ–Ω–∞—Ö": "tree-theme-monk",
        "–û—Ö–æ—Ç–Ω–∏–∫ –Ω–∞ –¥–µ–º–æ–Ω–æ–≤": "tree-theme-dh",
        "–ö–æ–ª–¥—É–Ω": "tree-theme-wd",
        "–ß–∞—Ä–æ–¥–µ–π": "tree-theme-wizard",
        "–ö—Ä–µ—Å—Ç–æ–Ω–æ—Å–µ—Ü": "tree-theme-crusader",
        "–ù–µ–∫—Ä–æ–º–∞–Ω—Ç": "tree-theme-necromancer"
    };
    if (themeMap[className]) viewport.classList.add(themeMap[className]);

        // 1. –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —É–∑–µ–ª (–ü–µ—Ä—Å–æ–Ω–∞–∂)

    const centerNode = document.createElement('div');
    centerNode.className = 'skill-node center-node';
  const classImages = {
        "–û—Ö–æ—Ç–Ω–∏–∫ –Ω–∞ –¥–µ–º–æ–Ω–æ–≤": "300px-Diablo-3-Demon-Hunter-01.jpg",
        "–í–∞—Ä–≤–∞—Ä": "–ø–µ—Ä—Å–æ–Ω–∞–∂–∏/300px-Diablo-3-Barbarian-01.jpg",
        "–ö—Ä–µ—Å—Ç–æ–Ω–æ—Å–µ—Ü": "–ø–µ—Ä—Å–æ–Ω–∞–∂–∏/300px-Diablo-3-Crusader-01.jpg",
        "–ú–æ–Ω–∞—Ö": "–ø–µ—Ä—Å–æ–Ω–∞–∂–∏/300px-Diablo-3-Monk-01.jpg",
        "–ö–æ–ª–¥—É–Ω": "–ø–µ—Ä—Å–æ–Ω–∞–∂–∏/300px-Diablo-3-Witch-Doctor-01.jpg",
        "–ß–∞—Ä–æ–¥–µ–π": "–ø–µ—Ä—Å–æ–Ω–∞–∂–∏/300px-Diablo-3-Wizard-01.jpg"
    };

    if (classImages[className]) {
        centerNode.style.backgroundImage = `url('${classImages[className]}')`;
        centerNode.style.backgroundSize = "cover";
        centerNode.style.backgroundPosition = "center";
        centerNode.innerHTML = ''; 
        centerNode.style.cursor = 'zoom-in';
                centerNode.onclick = () => window.openImageModal(classImages[className]);

    } else {
        centerNode.innerHTML = 'üë§';
    }
    centerNode.title = className;
    centerNode.style.left = '0px';
    centerNode.style.top = '0px';
    container.appendChild(centerNode);

    // 2. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≤—ã–∫–æ–≤ –ø–æ 5 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º (—Å–µ–∫—Ç–æ—Ä–∞–º)
    // –ï—Å–ª–∏ –Ω–∞–≤—ã–∫–æ–≤ –º–Ω–æ–≥–æ, –æ–Ω–∏ –±—É–¥—É—Ç —É—Ö–æ–¥–∏—Ç—å –¥–∞–ª—å—à–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞–≤—ã–∫–∏ –ø–æ —É—Ä–æ–≤–Ω—é –æ—Ç–∫—Ä—ã—Ç–∏—è, —Å–æ—Ö—Ä–∞–Ω—è—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å
    const skills = window.skillDB[className].map((s, i) => ({...s, originalIndex: i}));
    skills.sort((a, b) => (a.unlockLevel || 1) - (b.unlockLevel || 1));
    const sectors = 7; // 6 –∞–∫—Ç–∏–≤–Ω—ã—Ö + 1 –ø–∞—Å—Å–∏–≤–Ω—ã–µ
    const baseRadius = 100; // –ß—É—Ç—å –¥–∞–ª—å—à–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
        const levelStep = 120; // –£–≤–µ–ª–∏—á–∏–ª —à–∞–≥, —á—Ç–æ–±—ã —Ä—É–Ω—ã –Ω–µ —Å–ª–∏–ø–∞–ª–∏—Å—å
        const nodeCoords = {}; // –•—Ä–∞–Ω–∏–ª–∏—â–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –ª–∏–Ω–∏–π
    const sectorCounts = {}; // –°—á–µ—Ç—á–∏–∫ –Ω–∞–≤—ã–∫–æ–≤ –≤ –∫–∞–∂–¥–æ–º —Å–µ–∫—Ç–æ—Ä–µ –¥–ª—è –≥–ª—É–±–∏–Ω—ã
    
    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞–≤—ã–∫–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –±–∏–ª–¥–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
     const buildStatus = window.getBuildStatus(className);
    const isBuildMode = window.playerData.build && window.playerData.className === className;
        const hasProf3 = window.playerData.professions && window.playerData.professions[3];


    // –ö–∞—Ä—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ —Å–µ–∫—Ç–æ—Ä–∞–º
    let categoryMap = {};
    let categoryNumberMap = {}; // –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ü–∏—Ñ—Ä—ã –Ω–∞ –∏–∫–æ–Ω–∫–µ

    if (className === "–û—Ö–æ—Ç–Ω–∏–∫ –Ω–∞ –¥–µ–º–æ–Ω–æ–≤") {
        categoryMap = { "–û—Å–Ω–æ–≤–Ω–æ–µ": 0, "–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ": 1, "–ó–∞—â–∏—Ç–∞": 2, "–í—ã—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ": 3, "–ü—Ä–∏—Å–ø–æ—Å–æ–±–ª–µ–Ω–∏–µ": 4, "–°—Ç—Ä–µ–ª—å–±–∞": 5 };
    } else if (className === "–í–∞—Ä–≤–∞—Ä") {
        categoryMap = { "–û—Å–Ω–æ–≤–Ω–æ–µ": 0, "–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ": 1, "–ó–∞—â–∏—Ç–∞": 2, "–°–∏–ª–∞": 3, "–¢–∞–∫—Ç–∏–∫–∞": 4, "–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ": 5 };
    } else if (className === "–ú–æ–Ω–∞—Ö") {
        categoryMap = { "–û—Å–Ω–æ–≤–Ω–æ–µ": 0, "–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ": 1, "–ó–∞—â–∏—Ç–∞": 2, "–°–∏–ª–∞": 3, "–ß–∞—Ä—ã": 4, "–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ": 5 };
    } else if (className === "–ö–æ–ª–¥—É–Ω") {
        categoryMap = { "–û—Å–Ω–æ–≤–Ω–æ–µ": 0, "–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ": 1, "–ó–∞—â–∏—Ç–∞": 2, "–£–∂–∞—Å": 3, "–ù–µ–∫—Ä–æ–∑": 4, "–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ": 5 };
    } else if (className === "–ß–∞—Ä–æ–¥–µ–π") {
        categoryMap = { "–û—Å–Ω–æ–≤–Ω–æ–µ": 0, "–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ": 1, "–ó–∞—â–∏—Ç–∞": 2, "–°–∏–ª–∞": 3, "–ß–∞—Ä—ã": 4, "–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ": 5 };
    } else if (className === "–ö—Ä–µ—Å—Ç–æ–Ω–æ—Å–µ—Ü") {
        categoryMap = { "–û—Å–Ω–æ–≤–Ω–æ–µ": 0, "–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ": 1, "–ó–∞—â–∏—Ç–∞": 2, "–¢–∞–∫—Ç–∏–∫–∞": 3, "–ß–∞—Ä—ã": 4, "–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ": 5 };
    } else if (className === "–ù–µ–∫—Ä–æ–º–∞–Ω—Ç") {
        categoryMap = { "–û—Å–Ω–æ–≤–Ω–æ–µ": 0, "–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ": 1, "–¢—Ä—É–ø—ã": 2, "–†–µ–∞–Ω–∏–º–∞—Ü–∏—è": 3, "–ü—Ä–æ–∫–ª—è—Ç–∏—è": 4, "–ö—Ä–æ–≤—å –∏ –ö–æ—Å—Ç—å": 5 };
    } else {
        // –ê–≤—Ç–æ-–º–∞–ø–ø–∏–Ω–≥ –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤
        const cats = [...new Set(skills.map(s => s.category).filter(c => c !== "–ü–∞—Å—Å–∏–≤–Ω—ã–µ"))];
        cats.forEach((c, i) => categoryMap[c] = i % 6);
    }
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–∞—Ä—Ç—É –Ω–æ–º–µ—Ä–æ–≤ –¥–ª—è –±–µ–π–¥–∂–µ–π (1-6)
    for (let cat in categoryMap) {
        categoryNumberMap[cat] = categoryMap[cat] + 1;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª–∞—Å—Å–∞
    const savedLayout = window.customSkillLayouts[className];

    // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ –¥–ª—è –û—Ö–æ—Ç–Ω–∏–∫–∞ –Ω–∞ –¥–µ–º–æ–Ω–æ–≤
    const dhLayout = {
        "–°–∞–º–æ–Ω–∞–≤–æ–¥—è—â–∞—è—Å—è —Å—Ç—Ä–µ–ª–∞": { "x": 120, "y": 0 },
        "–ë—Ä–æ—Å–æ–∫ –∫–∏–Ω–∂–∞–ª–∞": { "x": 74.8188, "y": 93.8198 },
        "–ó–∞–º–µ–¥–ª—è—é—â–∏–π –≤—ã—Å—Ç—Ä–µ–ª": { "x": 200.621, "y": 62.0592 },
        "–®–∏–ø—ã": { "x": -26.7025, "y": 116.991 },
        "–°–∫–æ—Ä–æ—Å—Ç–Ω–∞—è —Å—Ç—Ä–µ–ª—å–±–∞": { "x": 76.5651, "y": 195.545 },
        "–î—ã–º–æ–≤–∞—è –∑–∞–≤–µ—Å–∞": { "x": -105.146, "y": 181.781 },
        "–ö—É–ª—å–±–∏—Ç": { "x": -108.116, "y": 52.066 },
        "–û—Ö–æ—Ç–Ω–∏—á–∏–π –∞–∑–∞—Ä—Ç": { "x": 61.1523, "y": -72.1533 },
        "–¢–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–≤–æ—Å—Ö–æ–¥—Å—Ç–≤–æ": { "x": 138.605, "y": -93.8247 },
        "–ë–æ–ª–∞—Å": { "x": 247.601, "y": 169.393 },
        "–®–∞–∫—Ä–∞–º": { "x": 21.9399, "y": 299.197 },
        "–ù–∞ –∏–∑–≥–æ—Ç–æ–≤–∫—É": { "x": -207.679, "y": 31.1326 },
        "–ö—Ä–æ–≤–∞–≤–∞—è –º–µ—Å—Ç—å": { "x": 218.479, "y": -88.6337 },
        "–í–µ–µ—Ä –∫–ª–∏–Ω–∫–æ–≤": { "x": -108.116, "y": -52.066 },
        "–û—Ç—Ö–æ–¥ –ø–æ–¥ –ø—Ä–∏–∫—Ä—ã—Ç–∏–µ–º": { "x": 242.428, "y": 305.497 },
        "–ì—Ä–∞–Ω–∞—Ç–∞": { "x": 173.932, "y": 447.379 },
        "–°–∏–ª–∞ —Ç—å–º—ã": { "x": -220.242, "y": 203.699 },
        "–¢–≤–µ—Ä–¥–∞—è —Ä—É–∫–∞": { "x": 285.333, "y": -54.7297 },
        "–®–∏–ø–∞—Å—Ç–∞—è –ª–æ–≤—É—à–∫–∞": { "x": -153.826, "y": -142.959 },
        "–ü–∏—Ç–æ–º–µ—Ü": { "x": -296.577, "y": -45.1877 },
        "–û–±—Å—Ç—Ä–µ–ª": { "x": -26.7025, "y": -116.991 },
        "–°—Ç—Ä–µ–ª–∞ —Å—Ç–∏—Ö–∏–π": { "x": -87.6962, "y": 380.012 },
        "–î–æ–±–∏–≤–∞–Ω–∏–µ": { "x": 345.838, "y": 2.9507 },
        "–ù–æ—á–Ω–æ–π –æ—Ö–æ—Ç–Ω–∏–∫": { "x": 398.953, "y": 71.5944 },
        "–ú–µ—Ç–∫–∞ —Å–º–µ—Ä—Ç–∏": { "x": -350.97, "y": -170.058 },
        "–ó–∞–ª–ø": { "x": 15.861, "y": -209.4 },
        "–¢—É—Ä–µ–ª—å": { "x": -149.584, "y": -260.047 },
        "–†–∞–∑–¥—É–º—å—è": { "x": 445.401, "y": 147.123 },
        "–†–∞–∑—Ä—ã–≤–Ω–∞—è —Å—Ç—Ä–µ–ª–∞": { "x": 110.049, "y": -279.086 },
        "–ñ–∞—Ä–∫–∞—è –ø–æ–≥–æ–Ω—è": { "x": 473.517, "y": 222.251 },
        "–õ–∏–≤–µ–Ω—å –≤–æ–∑–º–µ–∑–¥–∏—è": { "x": 243.893, "y": -304.329 },
        "–°—Ç—Ä–µ–ª—å–±–∞": { "x": 487.977, "y": 329.465 },
        "–°–∫–æ–≤—ã–≤–∞—é—â–∏–µ –ª–æ–≤—É—à–∫–∏": { "x": 483.098, "y": 425.739 },
        "–í–µ—Ä—à–∏–Ω–∞ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞": { "x": 458.657, "y": 516.948 },
        "–î–æ—Ä–∞–±–æ—Ç–∫–∞ –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤": { "x": 422.265, "y": 597.51 },
        "–ì—Ä–µ–Ω–∞–¥–µ—Ä": { "x": 366.451, "y": 659.962 },
        "–ú–µ—Ç–∫–∏–π —Å—Ç—Ä–µ–ª–æ–∫": { "x": 293.051, "y": 712.691 },
        "–ë–∞–ª–ª–∏—Å—Ç–∏–∫–∞": { "x": 221.514, "y": 753.038 },
        "–°–∞–º–æ–∏—Å—Ü–µ–ª–µ–Ω–∏–µ": { "x": 148.187, "y": 779.473 },
        "–í–æ–∑–º–µ–∑–¥–∏–µ": { "x": 397.459, "y": -269.122 },
        "–ó–∞—Å–∞–¥–∞": { "x": 63.4633, "y": 780.037 },
        "–ë–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å": { "x": -7.80733, "y": 763.96 },
        "–û—Ö–æ—Ç–∞ –Ω–∞ –æ–¥–∏–Ω–æ—á–∫—É": { "x": -78.0333, "y": 723.554 }
    };
    
    // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ –¥–ª—è –í–∞—Ä–≤–∞—Ä–∞
    const barbLayout = {
        "–°–æ–∫—Ä—É—à–∞—é—â–∏–π —É–¥–∞—Ä": { "x": -53.6364, "y": 99.0909 },
        "–ú–æ–ª–æ—Ç –î—Ä–µ–≤–Ω–∏—Ö": { "x": 48.1818, "y": 99.0909 },
        "–†–∞—Å—Å–µ–∫–∞—é—â–∏–π —É–¥–∞—Ä": { "x": -51.8182, "y": 180 },
        "–¢–æ–ø–æ—Ç": { "x": -178.91, "y": -79.1865 },
        "–†–≤–∞–Ω—ã–µ —Ä–∞–Ω—ã": { "x": 49.0909, "y": 180 },
        "–£–¥–∞—Ä –≤ –ø—Ä—ã–∂–∫–µ": { "x": -277.059, "y": -109.051 },
        "–°–≤–µ—Ä—Ö—Å–∏–ª–∞": { "x": -199.091, "y": 14.5455 },
        "–ö—É—Å–æ–∫ –º—è—Å–∞": { "x": 0, "y": -150 },
        "–û—Å—Ç–µ—Ä–≤–µ–Ω–µ–Ω–∏–µ": { "x": 0, "y": -210 },
        "–ë–µ—à–µ–Ω—Å—Ç–≤–æ": { "x": -50, "y": 260 },
        "–°–µ–π—Å–º–∏—á–µ—Å–∫–∏–π —É–¥–∞—Ä": { "x": 52.7273, "y": 256.364 },
        "–û—Ç–º—â–µ–Ω–∏–µ": { "x": -284.405, "y": 52.7832 },
        "–°—Ç–∞–ª—å–Ω—ã–µ –Ω–µ—Ä–≤—ã": { "x": 0, "y": -270 },
        "–£–≥—Ä–æ–∂–∞—é—â–∏–π –∫—Ä–∏–∫": { "x": 181.637, "y": -71.9138 },
        "–°–ø—Ä–∏–Ω—Ç": { "x": -380.668, "y": -115.245 },
        "–ú–∞—Å—Ç–µ—Ä—Å–∫–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ –æ—Ä—É–∂–∏–µ–º": { "x": 0, "y": -330 },
        "–ë—Ä–æ—Å–æ–∫ –æ—Ä—É–∂–∏—è": { "x": -47.2727, "y": 338.182 },
        "–ó–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏–µ": { "x": 198.182, "y": 16.3636 },
        "–í–∏—Ö—Ä—å": { "x": 57.2727, "y": 340 },
        "–û–±–æ–¥—Ä—è—é—â–∏–π –ø—Ä–∏–º–µ—Ä": { "x": 0, "y": -390 },
        "–Ø—Ä–æ—Å—Ç—å –±–µ—Ä—Å–µ—Ä–∫–∞": { "x": 0, "y": -450 },
        "–Ø—Ä–æ—Å—Ç–Ω—ã–π —Ä—ã–≤–æ–∫": { "x": -372.8, "y": 106.368 },
        "–°—Ç–æ–π–∫–æ—Å—Ç—å –∫ –±–æ–ª–∏": { "x": -481.604, "y": -115.561 },
        "–ë–æ–µ–≤–∞—è —è—Ä–æ—Å—Ç—å": { "x": 280.696, "y": -85.4143 },
        "–ö—Ä–æ–≤–æ–∂–∞–¥–Ω–æ—Å—Ç—å": { "x": 0, "y": -510 },
        "–ó–æ–≤ –î—Ä–µ–≤–Ω–∏—Ö": { "x": 295.315, "y": 50.056 },
        "–ö–æ–ø—å–µ –î—Ä–µ–≤–Ω–∏—Ö": { "x": 2.72727, "y": 430.909 },
        "–í—Ä–∞–∂–¥–µ–±–Ω–æ—Å—Ç—å": { "x": 0, "y": -570 },
        "–í–æ–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–ª–∏—á": { "x": 379.759, "y": -89.7905 },
        "–ì–Ω–µ–≤ –±–µ—Ä—Å–µ—Ä–∫–∞": { "x": 385.527, "y": 85.4589 },
        "–°—É–µ–≤–µ—Ä–∏–µ": { "x": 0, "y": -630 },
        "–¢–≤–µ—Ä–¥–æ—Å—Ç—å": { "x": 0, "y": -690 },
        "–ù–µ–æ—Ç–≤—Ä–∞—Ç–∏–º–∞—è –∫–∞—Ä–∞": { "x": 0, "y": -750 },
        "–ù–µ—É—Ç–æ–º–∏–º–æ—Å—Ç—å": { "x": 0, "y": -810 },
        "–ó–∞–¥–∏—Ä–∞": { "x": 0, "y": -870 },
        "–ù–µ—É–¥–µ—Ä–∂–∏–º–æ—Å—Ç—å": { "x": 0, "y": -930 },
        "–ë–µ—Å–ø–æ—â–∞–¥–Ω–æ—Å—Ç—å": { "x": 0, "y": -990 },
        "–ú–∏–ª–æ—Å—Ç—å –ë—É–ª-–ö–∞—Ç–æ—Å–∞": { "x": 0, "y": -1050 },
        "–õ–∞–≤–∏–Ω–∞": { "x": -460.716, "y": 169.34 },
        "–ú–æ—â—å –∑–µ–º–ª–∏": { "x": 0, "y": -1110 },
        "–ù–∞–ø–∞–¥–µ–Ω–∏–µ –∏ –∑–∞—â–∏—Ç–∞": { "x": 0, "y": -1170 },
        "–ë—É–π—Å—Ç–≤–æ": { "x": 0, "y": -1230 }
    };

    // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ –¥–ª—è –ß–∞—Ä–æ–¥–µ—è
    const wizLayout = {
        "–ú–∞–≥–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–µ–ª–∞": { "x": -185, "y": -10 },
        "–ú–æ—Ä–æ–∑–Ω—ã–π –ª—É—á": { "x": -280, "y": 51.9615 },
        "–®–æ–∫–æ–≤—ã–π —Ä–∞–∑—Ä—è–¥": { "x": -153.149, "y": 124.05 },
        "–ö–æ–ª—å—Ü–æ –ª—å–¥–∞": { "x": -278, "y": -87.9615 },
        "–ú–∞–≥–∏—á–µ—Å–∫–∞—è —Å—Ñ–µ—Ä–∞": { "x": -387.589, "y": -15.3127 },
        "–ê–ª–º–∞–∑–Ω–∞—è –∫–æ–∂–∞": { "x": -179.041, "y": -194.071 },
        "–°–∏–ª–æ–≤–∞—è –≤–æ–ª–Ω–∞": { "x": 250, "y": -250 },
        "–ñ–∞–∂–¥–∞ —ç–Ω–µ—Ä–≥–∏–∏": { "x": 50, "y": -150 },
        "–†–∞—Å–ø–ª—ã–≤—á–∞—Ç—ã–π —Å–∏–ª—É—ç—Ç": { "x": -50, "y": -260 },
        "–ü—Ä–∏–∑—Ä–∞—á–Ω—ã–π –∫–ª–∏–Ω–æ–∫": { "x": -363.187, "y": 153.491 },
        "–ú–∞–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫": { "x": -406.676, "y": -145.99 },
        "–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –≤–∏—Ö—Ä—å": { "x": 250, "y": -140 },
        "–£—Å–∫–æ—Ä–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ": { "x": 50, "y": -370 },
        "–õ–µ–¥—è–Ω–æ–π –¥–æ—Å–ø–µ—Ö": { "x": 350, "y": -250 },
        "–≠–ª–µ–∫—Ç—Ä–æ—à–æ–∫": { "x": -509.43, "y": 0.592367 },
        "–ó–∞–º–µ–¥–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏": { "x": -38.2465, "y": -94.3914 },
        "–•—Ä—É–ø–∫–∏–π —Ä–∞–∑—Ä—É—à–∏—Ç–µ–ª—å": { "x": -50, "y": -480 },
        "–î–æ—Å–ø–µ—Ö –±—É—Ä–∏": { "x": 353.846, "y": -142.308 },
        "–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –≤–∑—Ä—ã–≤": { "x": 450, "y": -251.538 },
        "–ú–∞–≥–∏—á–µ—Å–∫–æ–µ –æ—Ä—É–∂–∏–µ": { "x": 357.692, "y": -31.5385 },
        "–ì–µ–Ω–∏–∞–ª—å–Ω–æ—Å—Ç—å": { "x": 50, "y": -590 },
        "–ì–∏–¥—Ä–∞": { "x": 250, "y": -30 },
        "–†–∞—Å—â–µ–ø–ª–µ–Ω–∏–µ": { "x": -282.393, "y": -275.221 },
        "–§–∞–º–∏–ª–∏–∞—Ä": { "x": 362.308, "y": 86.1538 },
        "–¢–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è": { "x": 96.7118, "y": 276.851 },
        "–ê—Å—Ç—Ä–∞–ª—å–Ω–æ–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ": { "x": -50, "y": -700 },
        "–ó–µ—Ä–∫–∞–ª—å–Ω–æ–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ": { "x": 455.385, "y": -138.462 },
        "–ú–µ—Ç–µ–æ—Ä–∏—Ç": { "x": 250, "y": 80 },
        "–°–Ω–µ–∂–Ω–∞—è –±—É—Ä—è": { "x": 250, "y": 190 },
        "–ò–ª–ª—é–∑–∏–æ–Ω–∏—Å—Ç": { "x": 50, "y": -810 },
        "–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –¥–æ—Å–ø–µ—Ö": { "x": 370.769, "y": 193.077 },
        "–ê—Ä—Ö–æ–Ω—Ç": { "x": 461.538, "y": -30 },
        "–•–ª–∞–¥–Ω–æ–∫—Ä–æ–≤–∏–µ": { "x": -50, "y": -920 },
        "–í–æ—Å–ø–ª–∞–º–µ–Ω–µ–Ω–∏–µ": { "x": 50, "y": -1030 },
        "–ü–∞—Ä–∞–ª–∏—á": { "x": -50, "y": -1140 },
        "–ñ–∏–≤–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞": { "x": 50, "y": -1250 },
        "–í—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ—Ç–æ–∫": { "x": -50, "y": -1360 },
        "–ü–æ–∫–æ—Ä–µ–Ω–∏–µ": { "x": 50, "y": -1470 },
        "–ú–∞–≥–∏—á–µ—Å–∫–∏–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä": { "x": -50, "y": -1580 },
        "–ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞—è –∞–Ω–æ–º–∞–ª–∏—è": { "x": 50, "y": -1690 },
        "–ß–µ—Ä–Ω–∞—è –¥—ã—Ä–∞": { "x": 465.385, "y": 83.077 },
        "–ù–µ—Å–≥–∏–±–∞–µ–º–∞—è –≤–æ–ª—è": { "x": -50, "y": -1800 },
        "–°–º–µ–ª–æ—Å—Ç—å": { "x": 50, "y": -1910 },
        "–°–∏–ª–∞ —Å—Ç–∏—Ö–∏–π": { "x": -50, "y": -2020 }
    };

    // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ –¥–ª—è –ú–æ–Ω–∞—Ö–∞
    const monkLayout = {
        "–ö—É–ª–∞–∫–∏ –≥—Ä–æ–º–∞": { "x": -127.413, "y": 95.7081 },
        "–•–≤–æ—Å—Ç –¥—Ä–∞–∫–æ–Ω–∞": { "x": -158, "y": 3 },
        "–ö–∞—Å–∞–Ω–∏–µ —Å–º–µ—Ä—Ç–∏": { "x": -230.947, "y": 143.445 },
        "–û—Å–ª–µ–ø–ª—è—é—â–∞—è –≤—Å–ø—ã—à–∫–∞": { "x": -135.413, "y": -98.7081 },
        "–°—Ç—Ä–µ–º–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Ä–∞–≥–∞–Ω–∞": { "x": -270, "y": 3.30655e-14 },
        "–î—ã—Ö–∞–Ω–∏–µ –Ω–µ–±–µ—Å": { "x": -221.947, "y": -156.445 },
        "–ú–æ—â–Ω—ã–π —Ä—ã–≤–æ–∫": { "x": 137.413, "y": -95.7081 },
        "–†–µ—à–∏–º–æ—Å—Ç—å": { "x": 0, "y": -150 },
        "–õ–µ–≥–∫–∏–π —à–∞–≥": { "x": 0, "y": -260 },
        "–í–æ–ª–Ω–∞ —É–≤–µ—á–∏–π": { "x": -323.481, "y": 193.182 },
        "–í–æ–ª–Ω–∞ –°–≤–µ—Ç–∞": { "x": -380, "y": 4.65366e-14 },
        "–í–∑—Ä—ã–≤–Ω–æ–µ –∫–∞—Å–∞–Ω–∏–µ": { "x": 232.947, "y": -146.445 },
        "–õ–∏–∫—É—é—â–∞—è –¥—É—à–∞": { "x": 0, "y": -370 },
        "–£—Ä–∞–≥–∞–Ω–Ω—ã–π —É–¥–∞—Ä": { "x": 160, "y": 0 },
        "–ü—É—Ç—å –°–æ—Ç–Ω–∏ –ö—É–ª–∞–∫–æ–≤": { "x": -422.015, "y": 244.919 },
        "–ü–æ–∫–æ–π": { "x": -314.481, "y": -209.182 },
        "–ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ": { "x": 0, "y": -480 },
        "–°–µ–º—å —Å—Ç–æ—Ä–æ–Ω —Å–≤–µ—Ç–∞": { "x": 270, "y": 0 },
        "–ú–∞–Ω—Ç—Ä–∞ —Å–ø–∞—Å–µ–Ω–∏—è": { "x": 133.413, "y": 89.7081 },
        "–ü–µ—Å–Ω–æ–ø–µ–Ω–∏–µ": { "x": 0, "y": -590 },
        "–ü–µ—Ä–µ—Ö–≤–∞—Ç –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã": { "x": 0, "y": -700 },
        "–•–ª–µ—â—É—â–∏–π –≤–µ—Ç–µ—Ä": { "x": 332.481, "y": -196.182 },
        "–ú–∞–Ω—Ç—Ä–∞ –≤–æ–∑–¥–∞—è–Ω–∏—è": { "x": 223.947, "y": 144.445 },
        "–°–≤—è—Ç–∞—è —Å–≤—è—Ç—ã—Ö": { "x": -424.015, "y": -263.919 },
        "–¢–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–æ—é–∑–Ω–∏–∫": { "x": 380, "y": 0 },
        "–ü—É—Ç—å —Å—Ç—Ä–∞–∂–∞": { "x": 0, "y": -810 },
        "–ú–∞–Ω—Ç—Ä–∞ –∏—Å—Ü–µ–ª–µ–Ω–∏—è": { "x": 324.481, "y": 198.182 },
        "–®–µ—Å—Ç–æ–µ —á—É–≤—Å—Ç–≤–æ": { "x": 0, "y": -920 },
        "–ú–∞–Ω—Ç—Ä–∞ –æ—Å—É–∂–¥–µ–Ω–∏—è": { "x": 427.015, "y": 253.919 },
        "–¢–≤–µ—Ä–¥–∞—è –≤–æ–ª—è": { "x": 0, "y": -1030 },
        "–ë–µ–∑–∂–∞–ª–æ—Å—Ç–Ω—ã–π –Ω–∞—Ç–∏—Å–∫": { "x": 0, "y": -1140 },
        "–°–≤–µ—Ç–æ—á –ò—Ç–∞—Ä–∞": { "x": 0, "y": -1250 },
        "–°—Ç—Ä–µ–º–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å": { "x": 0, "y": -1360 },
        "–ì–∞—Ä–º–æ–Ω–∏—è": { "x": 0, "y": -1470 },
        "–ö–æ–º–±–∏–Ω–∞—Ü–∏—è —É–¥–∞—Ä–æ–≤": { "x": 0, "y": -1580 },
        "–ü–æ–∑–Ω–∞–Ω–∏–µ —Å–º–µ—Ä—Ç–∏": { "x": 0, "y": -1690 },
        "–ü—Ä–æ–∑—Ä–µ–Ω–∏–µ": { "x": 490, "y": 0 },
        "–ï–¥–∏–Ω—Å—Ç–≤–æ": { "x": 0, "y": -1800 },
        "–ò–º–ø—É–ª—å—Å": { "x": 0, "y": -1910 },
        "–ù–µ–∑–µ–º–Ω–æ–π —Ä–∏—Ç–º": { "x": 0, "y": -2020 }
    };

    // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ –¥–ª—è –ö–æ–ª–¥—É–Ω–∞
    const wdLayout = {
        "–û—Ç—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –¥—Ä–æ—Ç–∏–∫": { "x": -150, "y": -100 },
        "–û–±—ä—è—Ç–∏—è —Å–º–µ—Ä—Ç–∏": { "x": -240.909, "y": -104.545 },
        "–¢—Ä—É–ø–Ω—ã–µ –ø–∞—É–∫–∏": { "x": -124.756, "y": 10 },
        "–ü—Ä–∏–∑—ã–≤ –ø—Å–æ–≤-–∑–æ–º–±–∏": { "x": -336.364, "y": -107.273 },
        "–û–≥–Ω–µ–Ω–Ω—ã–µ –Ω–µ—Ç–æ–ø—ã—Ä–∏": { "x": -213.847, "y": 7.27273 },
        "–£–∂–∞—Å": { "x": -317.483, "y": 9.09091 },
        "–ñ–∞—Ç–≤–∞ –¥—É—à": { "x": 155, "y": -58 },
        "–ü–µ—Ä–≤–æ–±—ã—Ç–Ω–∞—è —Å—Ç–æ–π–∫–æ—Å—Ç—å": { "x": 0, "y": 200 },
        "–ö—Ä—É–≥ –∂–∏–∑–Ω–∏": { "x": 0, "y": 310 },
        "–ù–∞—à–µ—Å—Ç–≤–∏–µ –∂–∞–±": { "x": -122.721, "y": 120 },
        "–ú—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–π –¥—É—Ö": { "x": -205.448, "y": 119.091 },
        "–ñ–µ—Ä—Ç–≤–µ–Ω–Ω—ã–π –æ–±—Ä—è–¥": { "x": 180.5, "y": 29 },
        "–ë–ª–∏–∑–æ—Å—Ç—å –∫ –¥—É—Ö–∞–º": { "x": 0, "y": 420 },
        "–ó–æ–º–±–∏-–±–µ—Ä—Å–µ—Ä–∫": { "x": 249, "y": -90 },
        "–ü–æ—Å—Ç—É–ø—å –¥—É—Ö–∞": { "x": -305.448, "y": 117.273 },
        "–ñ—É—Ç–∫–∞—è —Ç—Ä–∞–ø–µ–∑–∞": { "x": 0, "y": 530 },
        "–ü—Ä–∏–∑—Ä–∞—á–Ω—ã–π —à–∫–≤–∞–ª": { "x": 276.5, "y": 2 },
        "–ì—Ä–æ–º–∞–¥–µ–Ω—å": { "x": 346, "y": -114 },
        "–ö—Ä–æ–≤–∞–≤—ã–π —Ä–∏—Ç—É–∞–ª": { "x": 0, "y": 640 },
        "–û–ø–∞—Å–Ω—ã–π —è–¥": { "x": 0, "y": 750 },
        "–û–≥–Ω–µ–Ω–Ω–∞—è –±–æ–º–±–∞": { "x": -145.766, "y": 230 },
        "–†–æ–π —Å–∞—Ä–∞–Ω—á–∏": { "x": -237.584, "y": 236.364 },
        "–°–≥–ª–∞–∑": { "x": -336.675, "y": 230.909 },
        "–ï–¥–∫–æ–µ –æ–±–ª–∞–∫–æ": { "x": 311, "y": 109 },
        "–í—Å–µ–æ–±—â–µ–µ –ø–æ–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ": { "x": 214, "y": 132 },
        "–•–æ–∑—è–∏–Ω –∑–æ–º–±–∏": { "x": 0, "y": 860 },
        "–ë–æ–ª—å—à–æ–µ —Å—Ç—Ä–∞—à–Ω–æ–µ –≤—É–¥—É": { "x": 387.5, "y": -18 },
        "–®–∞–≥ –∑–∞ –≥—Ä–∞–Ω—å": { "x": 0, "y": 970 },
        "–°—Ç–µ–Ω–∞ —Å–º–µ—Ä—Ç–∏": { "x": 346.25, "y": 210.75 },
        "–ê—Ä–º–∏—è —Ñ–µ—Ç–∏—à–µ–π": { "x": 416, "y": 86 },
        "–í–º–µ—Å—Ç–∏–ª–∏—â–µ –¥—É—Ö–æ–≤": { "x": 0, "y": 1080 },
        "–õ—å—Å—Ç–∏–≤—ã–µ —Ñ–µ—Ç–∏—à–∏": { "x": 0, "y": 1190 },
        "–ë–µ—Å–ø–æ–∫–æ–π–Ω—ã–µ –¥—É—Ö–∏": { "x": 0, "y": 1300 },
        "–ü–æ–∏—Å–∫–∏ –ø—Ä–æ–∑—Ä–µ–Ω–∏—è": { "x": 0, "y": 1410 },
        "–†—å—è–Ω–∞—è –ø—Ä–µ–¥–∞–Ω–Ω–æ—Å—Ç—å": { "x": 0, "y": 1520 },
        "–ù–µ—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–∞—è —Å–º–µ—Ä—Ç—å": { "x": 0, "y": 1630 },
        "–ü–ª–µ–º–µ–Ω–Ω–æ–π –æ–±—Ä—è–¥": { "x": 0, "y": 1740 },
        "–†–∏—Ç—É–∞–ª –¥–æ–≤–µ—Ä–∏—è": { "x": 0, "y": 1850 },
        "–ü–∏—Ä–∞–Ω—å–∏": { "x": 454.5, "y": 193.25 },
        "–ú–µ–¥–ª–µ–Ω–Ω–∞—è —Å–º–µ—Ä—Ç—å": { "x": 0, "y": 1960 },
        "–ë–æ–ª–æ—Ç–Ω–∞—è –≥–∞—Ä–º–æ–Ω–∏—è": { "x": 0, "y": 2070 },
        "–ü–æ–ª—É–Ω–æ—á–Ω—ã–π –ø–∏—Ä": { "x": 0, "y": 2180 }
    };

    // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ –¥–ª—è –ö—Ä–µ—Å—Ç–æ–Ω–æ—Å—Ü–∞
    const crusaderLayout = {
        "–ù–∞–∫–∞–∑–∞–Ω–∏–µ": { "x": 250, "y": -200 },
        "–£–¥–∞—Ä —â–∏—Ç–æ–º": { "x": 373.167, "y": -234.5 },
        "–£–¥–∞—Ä —Å–ø–ª–µ—á–∞": { "x": 250, "y": -90 },
        "–°–∏—è—é—â–∏–π —â–∏—Ç": { "x": 480.5, "y": -268.667 },
        "–®–∏—Ä–æ–∫–∏–π –∑–∞–º–∞—Ö": { "x": 371.833, "y": -117.333 },
        "–ñ–µ–ª–µ–∑–Ω–∞—è –∫–æ–∂–∞": { "x": 480, "y": -164 },
        "–ù–∞—Å–º–µ—à–∫–∞": { "x": -334.853, "y": 84.8528 },
        "–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –º–æ—â—å": { "x": 0, "y": 150 },
        "–†–≤–µ–Ω–∏–µ": { "x": 0, "y": 260 },
        "–ö–∞—Ä–∞": { "x": 250, "y": 20 },
        "–û—Å–≤—è—â–µ–Ω–Ω—ã–π –º–æ–ª–æ—Ç": { "x": 370.667, "y": -4 },
        "–°–∫–∞–∫—É–Ω": { "x": -412.635, "y": 162.635 },
        "–ë–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å": { "x": 0, "y": 370 },
        "–ü—Ä–∏–Ω—Ü–∏–ø –¥–æ–±–ª–µ—Å—Ç–∏": { "x": -370, "y": 1.46958e-14 },
        "–ü—Ä–∞–≤–æ—Å—É–¥–∏–µ": { "x": 250, "y": 130 },
        "–û—Å–≤—è—â–µ–Ω–∏–µ": { "x": 488, "y": -55 },
        "–ü—Ä–∞–≤–µ–¥–Ω–æ—Å—Ç—å": { "x": 0, "y": 480 },
        "–ü—Ä–∏–Ω—Ü–∏–ø —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç–∏": { "x": -480, "y": 2.81669e-14 },
        "–ü–∞–¥–∞—é—â–∏–π –º–µ—á": { "x": -334.853, "y": -84.8528 },
        "–û—Å–≤—è—â–µ–Ω–Ω—ã–π —â–∏—Ç": { "x": 374.5, "y": 106 },
        "–ù–µ—Å–æ–∫—Ä—É—à–∏–º—ã–π –±–æ–µ—Ü": { "x": 0, "y": 590 },
        "–§–∞–Ω–∞—Ç–∏–∑–º": { "x": 0, "y": 700 },
        "–ü–æ—Ä–∏—Ü–∞–Ω–∏–µ": { "x": -490.416, "y": 240.416 },
        "–°—É–¥": { "x": 492, "y": 51 },
        "–ü—Ä–∏–Ω—Ü–∏–ø –Ω–∞–¥–µ–∂–¥—ã": { "x": -590, "y": 4.1638e-14 },
        "–ü–æ–±–æ—Ä–Ω–∏–∫ –ê–∫–∞—Ä–∞—Ç–∞": { "x": -412.635, "y": -162.635 },
        "–ù–µ–ø—Ä–æ–±–∏–≤–∞–µ–º–∞—è –±—Ä–æ–Ω—è": { "x": 0, "y": 810 },
        "–Ø—Ä–æ—Å—Ç—å –ù–µ–±–µ—Å": { "x": -490.416, "y": -240.416 },
        "–§–∞–ª–∞–Ω–≥–∞": { "x": -568.198, "y": 318.198 },
        "–ë–ª–∞–≥–æ–µ –¥–µ–ª–æ": { "x": 0, "y": 920 },
        "–î–ª–∞–Ω—å –Ω–µ–±–µ—Å": { "x": 377.667, "y": 221.333 },
        "–ü—Ä–∞–≤–µ–¥–Ω—ã–π –≥–Ω–µ–≤": { "x": 0, "y": 1030 },
        "–°–≤—è—â–µ–Ω–Ω–∞—è —Ç–≤–µ—Ä–¥—ã–Ω—è": { "x": 0, "y": 1140 },
        "–õ–æ—Ä–¥-–∫–æ–º–∞–Ω–¥—É—é—â–∏–π": { "x": 0, "y": 1250 },
        "–ù–∏ —à–∞–≥—É –Ω–∞–∑–∞–¥": { "x": 0, "y": 1360 },
        "–î–ª–∏–Ω–Ω–∞—è —Ä—É–∫–∞ –∑–∞–∫–æ–Ω–∞": { "x": 0, "y": 1470 },
        "–ñ–µ–ª–µ–∑–Ω–∞—è –¥–µ–≤–∞": { "x": 0, "y": 1580 },
        "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ": { "x": 0, "y": 1690 },
        "–ú–Ω–æ–≥–æ—Ü–≤–µ—Ç–∏–µ": { "x": 0, "y": 1800 },
        "–ë–æ–º–±–∞—Ä–¥–∏—Ä–æ–≤–∫–∞": { "x": -568.198, "y": -318.198 },
        "–†–µ–∑–∫–æ—Å—Ç—å": { "x": 0, "y": 1910 },
        "–ù–∞–¥–µ–∂–Ω—ã–π —â–∏—Ç": { "x": 0, "y": 2020 }
    };

     skills.forEach((skill, sortedIdx) => {
        const idx = sortedIdx; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω–¥–µ–∫—Å –ø–æ—Å–ª–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
        const originalIdx = skill.originalIndex;
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–µ–∫—Ç–æ—Ä (0-6)
        let sector;
        if (skill.category === "–ü–∞—Å—Å–∏–≤–Ω—ã–µ") {
            sector = 6; // –ü–∞—Å—Å–∏–≤–∫–∏ –≤—Å–µ–≥–¥–∞ 7-–π —Å–µ–∫—Ç–æ—Ä (–∏–Ω–¥–µ–∫—Å 6)
        } else {
            sector = categoryMap[skill.category];
            if (sector === undefined) sector = idx % 6;
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª—É–±–∏–Ω—É (—É–¥–∞–ª–µ–Ω–Ω–æ—Å—Ç—å –æ—Ç —Ü–µ–Ω—Ç—Ä–∞)
        const depth = sectorCounts[sector] || 0;
        sectorCounts[sector] = (sectorCounts[sector] || 0) + 1;

        // --- –õ–û–ì–ò–ö–ê –ö–û–û–†–î–ò–ù–ê–¢ –ü–û –ö–õ–ê–°–°–ê–ú ---
        let x = 0, y = 0;

        // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è, –±–µ—Ä–µ–º –µ—ë
        if (savedLayout && savedLayout[skill.name]) {
            x = savedLayout[skill.name].x;
            y = savedLayout[skill.name].y;
        } else {
            // –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
            if (className === "–û—Ö–æ—Ç–Ω–∏–∫ –Ω–∞ –¥–µ–º–æ–Ω–æ–≤") {
                if (dhLayout[skill.name]) {
                    x = dhLayout[skill.name].x;
                    y = dhLayout[skill.name].y;
                } else {
                    // –°—é—Ä–∏–∫–µ–Ω / –°–ø–∏—Ä–∞–ª—å (7 –ª—É—á–µ–π) - —Ñ–æ–ª–ª–±–µ–∫
                    const angle = (sector * (2 * Math.PI / 7)) + (depth * 0.3); // –ó–∞–∫—Ä—É—á–∏–≤–∞–Ω–∏–µ
                    const r = 120 + depth * 110;
                    x = Math.cos(angle) * r;
                    y = Math.sin(angle) * r;
                }
            } 
            else if (className === "–í–∞—Ä–≤–∞—Ä") {
                if (barbLayout[skill.name]) {
                    x = barbLayout[skill.name].x;
                    y = barbLayout[skill.name].y;
                } else {
                    // –î–≤—É—Ä—É—á–Ω—ã–π —Ç–æ–ø–æ—Ä - —Ñ–æ–ª–ª–±–µ–∫
                    if (sector === 6) { x = 0; y = -150 - depth * 60; }
                    else if (sector <= 1) { x = (sector === 0 ? -20 : 20); y = 100 + depth * 80; }
                    else if (sector <= 3) { const angle = Math.PI + 0.5 - ((sector-2)*0.5) - (depth * 0.1); const r = 150 + depth * 60; x = Math.cos(angle) * r - 50; y = Math.sin(angle) * r; }
                    else { const angle = 0 - 0.5 + ((sector-4)*0.5) + (depth * 0.1); const r = 150 + depth * 60; x = Math.cos(angle) * r + 50; y = Math.sin(angle) * r; }
                }
            }
            else if (className === "–ö—Ä–µ—Å—Ç–æ–Ω–æ—Å–µ—Ü") {
                if (crusaderLayout[skill.name]) {
                    x = crusaderLayout[skill.name].x;
                    y = crusaderLayout[skill.name].y;
                } else {
                    // –©–∏—Ç (–°–ª–µ–≤–∞) –∏ –ú–µ—á (–°–ø—Ä–∞–≤–∞) - —Ñ–æ–ª–ª–±–µ–∫
                    if (sector <= 2) { x = 250 + (sector % 2) * 40; y = -200 + depth * 110 + (sector * 30); }
                    else if (sector <= 5) { const angle = Math.PI - (Math.PI/4) + ((sector-3) * (Math.PI/4)); const r = 120 + depth * 110; x = -250 + Math.cos(angle) * r; y = Math.sin(angle) * r; }
                    else { x = 0; y = 150 + depth * 110; }
                }
            }
            else if (className === "–ß–∞—Ä–æ–¥–µ–π") {
                if (wizLayout[skill.name]) {
                    x = wizLayout[skill.name].x;
                    y = wizLayout[skill.name].y;
                } else {
                    // –°—Ñ–µ—Ä–∞ (–°–ª–µ–≤–∞) –∏ –ñ–µ–∑–ª (–°–ø—Ä–∞–≤–∞) - —Ñ–æ–ª–ª–±–µ–∫
                    if (sector <= 2) { 
                        const angle = (sector * (2*Math.PI/3)) + depth; const r = 60 + depth * 110; x = -250 + Math.cos(angle) * r; y = Math.sin(angle) * r; 
                    } else if (sector <= 5) { x = 250 + (sector-3)*30; y = -250 + depth * 110; 
                    } else { x = (depth % 2 === 0 ? 50 : -50); y = -150 - depth * 110; }
                }
            }
            else if (className === "–ö–æ–ª–¥—É–Ω") {
                if (wdLayout[skill.name]) {
                    x = wdLayout[skill.name].x;
                    y = wdLayout[skill.name].y;
                } else {
                    // –¢–∞–ª–∏—Å–º–∞–Ω (–ó–º–µ–∏) –∏ –ù–æ–∂ - —Ñ–æ–ª–ª–±–µ–∫
                    if (sector <= 2) { x = -150 - (sector * 60) + Math.sin(depth)*30; y = -100 + depth * 110; }
                    else if (sector <= 5) { const t = depth * 0.35 + (sector-3)*0.1; x = 150 + t * 250; y = -100 + Math.pow(t, 2) * 400; }
                    else { x = 0; y = 200 + depth * 110; }
                }
            }
            else if (className === "–ú–æ–Ω–∞—Ö") {
                if (monkLayout[skill.name]) {
                    x = monkLayout[skill.name].x;
                    y = monkLayout[skill.name].y;
                } else {
                    // –ö–æ–≥—Ç–∏ - —Ñ–æ–ª–ª–±–µ–∫
                    if (sector <= 2) { const angle = Math.PI - 0.5 + (sector * 0.5); const r = 160 + depth * 110; x = Math.cos(angle) * r; y = Math.sin(angle) * r; }
                    else if (sector <= 5) { const angle = 0 - 0.5 + ((sector-3) * 0.5); const r = 160 + depth * 110; x = Math.cos(angle) * r; y = Math.sin(angle) * r; }
                    else { x = 0; y = -150 - depth * 110; }
                }
            }
            else {
                // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ù–µ–∫—Ä–æ–º–∞–Ω—Ç –∏ –¥—Ä.) - –ó–≤–µ–∑–¥–∞ 7 –ª—É—á–µ–π
                const angle = (sector * (2 * Math.PI / 7));
                const r = 130 + depth * 100;
                x = Math.cos(angle) * r;
                y = Math.sin(angle) * r;
            }
        }

         // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        nodeCoords[idx] = { x, y };

      // –õ–∏–Ω–∏–∏
        let parentX = 0, parentY = 0;
        if (depth === 0) {
            // –ü–µ—Ä–≤—ã–µ 5 –Ω–∞–≤—ã–∫–æ–≤ —Å–æ–µ–¥–∏–Ω—è—é—Ç—Å—è —Å —Ü–µ–Ω—Ç—Ä–æ–º
            window.drawTreeLine(0, 0, x, y, container);
        } else if (depth > 0) {
            // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å–æ–µ–¥–∏–Ω—è—é—Ç—Å—è —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –Ω–∞–≤—ã–∫–æ–º –≤ —ç—Ç–æ–º —Å–µ–∫—Ç–æ—Ä–µ (–Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –µ–≥–æ –∏–Ω–¥–µ–∫—Å)
            // –¢–∞–∫ –∫–∞–∫ –º—ã –∏–¥–µ–º –ø–æ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É —Å–ø–∏—Å–∫—É, –ø—Ä–µ–¥—ã–¥—É—â–∏–π –Ω–∞–≤—ã–∫ –≤ —ç—Ç–æ–º —Å–µ–∫—Ç–æ—Ä–µ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
            // –ù–æ —É –Ω–∞—Å –Ω–µ—Ç –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –µ–≥–æ –∏–Ω–¥–µ–∫—Å—É –≤ sorted list –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.
            // –£–ø—Ä–æ—â–µ–Ω–∏–µ: —Å–æ–µ–¥–∏–Ω—è–µ–º —Å (0,0) –µ—Å–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–æ –ª—É—á—à–µ –Ω–∞–π—Ç–∏.
            // –ú—ã –º–æ–∂–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —É–∑–µ–ª –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞.
        }
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ª–∏–Ω–∏–π:
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É–∑–ª–∞ –≤ —Å–µ–∫—Ç–æ—Ä–µ
        if (!window.skillTreeSectorLastNode) window.skillTreeSectorLastNode = {};
        
        if (depth === 0) {
            window.drawTreeLine(0, 0, x, y, container);
        } else {
            const parentNode = window.skillTreeSectorLastNode[sector];
            if (parentNode) {
                window.drawTreeLine(parentNode.x, parentNode.y, x, y, container);
            }
        }
        window.skillTreeSectorLastNode[sector] = { x, y };

        /* –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –ª–∏–Ω–∏–π (—É–¥–∞–ª–µ–Ω–∞)
        if (depth === 0) {
            window.drawTreeLine(0, 0, x, y, container);
        } else {
            const parentIdx = idx - sectors; // –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
            if (nodeCoords[parentIdx]) {
                parentX = nodeCoords[parentIdx].x;
                parentY = nodeCoords[parentIdx].y;
                window.drawTreeLine(parentX, parentY, x, y, container);
            }
        }
        */

               // –£–∑–µ–ª –Ω–∞–≤—ã–∫–∞
        const node = document.createElement('div');
        node.className = 'skill-node';
                if (skill.category === "–ü–∞—Å—Å–∏–≤–Ω—ã–µ") node.classList.add('passive-node');
        node.dataset.skillName = skill.name; // –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        if (skill.icon) {
            node.style.backgroundImage = `url('${skill.icon}')`;
            node.style.backgroundSize = 'cover';
            node.innerHTML = '';
        } else {
            node.innerHTML = skill.name[0]; // –ò–∫–æ–Ω–∫–∞/–ë—É–∫–≤–∞
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Ü–∏—Ñ—Ä—É –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        if (skill.category !== "–ü–∞—Å—Å–∏–≤–Ω—ã–µ" && categoryNumberMap[skill.category]) {
            const catBadge = document.createElement('div');
            catBadge.className = 'skill-cat-badge';
            catBadge.innerText = categoryNumberMap[skill.category];
            node.appendChild(catBadge);
        }

        node.title = skill.name;
        node.style.left = `${x}px`;
        node.style.top = `${y}px`;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –∫ –±–∏–ª–¥—É
        let isAllowed = true;
                        let isBuildPlanned = false;
        if (isBuildMode) {
                       // –ü–æ–∏—Å–∫ –Ω–∞–≤—ã–∫–∞ –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö –±–∏–ª–¥–∞ (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
            let foundRule = null;
            let ruleGroupNum = -1;
            
            if (skill.category === "–ü–∞—Å—Å–∏–≤–Ω—ã–µ") {
                for (const [num, rule] of Object.entries(buildStatus.passiveRules)) {
                    if (rule.skills.includes(skill.name) || rule.any) {
                        foundRule = rule;
                        ruleGroupNum = num;
                        break;
                    }
                }
            } else {
               for (const [num, rule] of Object.entries(buildStatus.categoryRules)) {
                    if (rule.skills.includes(skill.name)) {
                        foundRule = rule;
                        ruleGroupNum = num;
                        break;
                    }
                }
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ –∏–º–µ–Ω–∏, –∏—â–µ–º –ø—Ä–∞–≤–∏–ª–æ "Any" –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —ç—Ç–æ–≥–æ –Ω–∞–≤—ã–∫–∞
                if (!foundRule) {
                    const catNum = categoryNumberMap[skill.category];
                    if (buildStatus.categoryRules[catNum] && buildStatus.categoryRules[catNum].any) {
                        foundRule = buildStatus.categoryRules[catNum];
                        ruleGroupNum = catNum;
                    }
                }
            }

            if (foundRule) {
                isBuildPlanned = true; // –ù–∞–≤—ã–∫ –µ—Å—Ç—å –≤ –ø–ª–∞–Ω–µ
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø–µ
                if (foundRule.any) {
                    isAllowed = true;
                } else {
                    // –ï—Å–ª–∏ –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ —É–∂–µ –≤—ã—É—á–µ–Ω –î–†–£–ì–û–ô –Ω–∞–≤—ã–∫ -> –±–ª–æ–∫–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–π
                    const learnedInGroup = foundRule.skills.filter(sName => window.playerData.learnedSkills[sName]);
                    if (learnedInGroup.length > 0 && !window.playerData.learnedSkills[skill.name]) {
                        isAllowed = false;
                    } else {
                                                isAllowed = true;
                    }
               
                }
                } else {
                // –ù–∞–≤—ã–∫–∞ –Ω–µ—Ç –≤ –±–∏–ª–¥–µ
                isAllowed = false;
            }

            if (!isAllowed) {
                node.classList.add('dimmed');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (1 –Ω–∞–≤—ã–∫ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –µ—Å–ª–∏ –Ω–µ 3-—è –ø—Ä–æ—Ñ–∞)
               if (skill.category !== "–ü–∞—Å—Å–∏–≤–Ω—ã–µ" && !hasProf3) {
            const learnedInThisCat = skills.filter(s => 
                s.category === skill.category && 
                window.playerData.learnedSkills[s.name]
            );
            
            // –õ–∏–º–∏—Ç: 1 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. +1 –µ—Å–ª–∏ –µ—Å—Ç—å 3-—è –ø—Ä–æ—Ñ–µ—Å—Å–∏—è.
            let catLimit = 1;
            if (window.playerData.professions && window.playerData.professions[3]) {
                catLimit = 2;
            }

            // –ï—Å–ª–∏ –ª–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω –∏ —ç—Ç–æ—Ç –Ω–∞–≤—ã–∫ –Ω–µ –∏–∑—É—á–µ–Ω -> –∑–∞—Ç–µ–º–Ω—è–µ–º
            if (learnedInThisCat.length >= catLimit && !window.playerData.learnedSkills[skill.name]) {
                node.classList.add('dimmed');
                                isAllowed = false; // –ë–ª–æ–∫–∏—Ä—É–µ–º –∏ —Ä—É–Ω—ã —Ç–æ–∂–µ
                // node.title += " (–õ–∏–º–∏—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏—Å—á–µ—Ä–ø–∞–Ω)"; // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
            }
        }

         // –ü–†–ê–í–ò–õ–û 3-–π –ü–†–û–§–ï–°–°–ò–ò: –ï—Å–ª–∏ –∏–∑—É—á–µ–Ω–∞, —Å–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –±–∏–ª–¥–∞ (–Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–ª–∞–Ω–∞)
        if (hasProf3) {
            node.classList.remove('dimmed');
            isAllowed = true;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è (–∑–∞–≥–ª—É—à–∫–∞, –ø–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î)
        const unlockLvl = skill.unlockLevel || 1;
        const playerLvl = window.playerData.level || 1;
        if (playerLvl < unlockLvl) {
            node.classList.add('locked');
            node.title += ` (–¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ä. ${unlockLvl})`;
            // –ï—Å–ª–∏ –Ω–∞–≤—ã–∫ –≤ –±–∏–ª–¥–µ, –Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ø–æ —É—Ä–æ–≤–Ω—é - –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∑–µ–ª–µ–Ω—ã–º
            if (isBuildPlanned) {
                node.classList.add('build-planned');
            }
        } else if (isAllowed) {
                        node.onclick = () => window.selectTreeSkill(originalIdx, node);
        }

        if (window.playerData.learnedSkills[skill.name]) {
            node.classList.add('learned');
        }

        // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞, –¥–µ–ª–∞–µ–º —É–∑–µ–ª –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–º
        if (window.isSkillTreeEditing) {
            window.makeNodeDraggable(node);
        }

                      container.appendChild(node);


        // –†—É–Ω—ã (—Å–ø—É—Ç–Ω–∏–∫–∏)
        // 5 —Ä—É–Ω –≤–æ–∫—Ä—É–≥ –Ω–∞–≤—ã–∫–∞
                if (skill.category !== "–ü–∞—Å—Å–∏–≤–Ω—ã–µ") {
               const runeRadius = 40; // –ß—É—Ç—å —à–∏—Ä–µ –æ—Ä–±–∏—Ç–∞
        skill.runes.forEach((rune, rIdx) => {
                            if (rIdx === 0) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –±–∞–∑–æ–≤—É—é —Ä—É–Ω—É –Ω–∞ –∫–∞—Ä—Ç–µ
            // –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–≤–µ–Ω—å —Ä—É–Ω—ã (–µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω, –±–µ—Ä–µ–º —É—Ä–æ–≤–µ–Ω—å –Ω–∞–≤—ã–∫–∞)
            const runeUnlock = rune.unlockLevel || unlockLvl;
             // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏: –ï—Å–ª–∏ —É—Ä–æ–≤–µ–Ω—å –º–∞–ª –ò —ç—Ç–æ –Ω–µ —á–∞—Å—Ç—å –±–∏–ª–¥–∞ -> –°–∫—Ä—ã–≤–∞–µ–º
            // (–ù–æ –µ—Å–ª–∏ —ç—Ç–æ —á–∞—Å—Ç—å –±–∏–ª–¥–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–∂–µ –Ω–∞ 1 —É—Ä–æ–≤–Ω–µ, –Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π)
            let isRunePlanned = false;
            if (isBuildPlanned) {
                 // –ï—Å–ª–∏ —Å–∞–º –Ω–∞–≤—ã–∫ –≤ –ø–ª–∞–Ω–µ, —Å—á–∏—Ç–∞–µ–º —Ä—É–Ω—ã –≤–∏–¥–∏–º—ã–º–∏ (–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ —É—Ä–æ–≤–Ω—é)
                 isRunePlanned = true;
            }
            
            // if (playerLvl < runeUnlock && !isRunePlanned) return; // –£–ë–†–ê–ù–û: –¢–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ä—É–Ω—ã

            const rAngle = (rIdx * (360 / 5)) * (Math.PI / 180); // 5 —Ä—É–Ω —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ
            const rX = x + Math.cos(rAngle) * runeRadius;
            const rY = y + Math.sin(rAngle) * runeRadius;

            const runeNode = document.createElement('div');
            runeNode.className = 'rune-node';
            
           // –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Ä—É–Ω—ã (1-5)
            const imgNum = (rIdx % 5) + 1;
            runeNode.style.backgroundImage = `url('—Ä—É–Ω—ã –Ω–∞–≤—ã–∫–æ–≤/D3-RuneStone${imgNum}.png')`;
            runeNode.style.backgroundSize = 'cover';
            runeNode.style.border = 'none'; // –£–±–∏—Ä–∞–µ–º —Ä–∞–º–∫—É, —Ç–∞–∫ –∫–∞–∫ –µ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∞
            runeNode.style.backgroundColor = 'transparent';
            
                        runeNode.title = `${rune.name} (–£—Ä. ${runeUnlock})`;
            runeNode.style.left = `${rX}px`;
            runeNode.style.top = `${rY}px`;
            
                       // –õ–æ–≥–∏–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ä—É–Ω—ã
            if (playerLvl < runeUnlock) {
                runeNode.classList.add('locked');
                
                // –ï—Å–ª–∏ —Ä—É–Ω–∞ –≤ –±–∏–ª–¥–µ, –Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ —É—Ä–æ–≤–Ω—é - –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º (–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π)
                if (isAllowed && isBuildMode) {
                    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü —Å—Ç–∏–ª—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                }
            } else if (isAllowed) {

                runeNode.onclick = (e) => {
                    e.stopPropagation();
                                        window.selectTreeSkill(originalIdx, node); // –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–∏—Ä–∞–µ–º –Ω–∞–≤—ã–∫
                    // –ó–∞—Ç–µ–º –≤—ã–±–∏—Ä–∞–µ–º —Ä—É–Ω—É (—ç–º—É–ª—è—Ü–∏—è –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ –≤ –ø–∞–Ω–µ–ª–∏)
                    setTimeout(() => {
                        const runeBtns = document.querySelectorAll('.rune-btn');
                        if (runeBtns[rIdx]) runeBtns[rIdx].click();
                    }, 50);
                };
                  } 

                  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑—É—á–µ–Ω–Ω–æ—Å—Ç–∏ —Ä—É–Ω—ã –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
            if (window.playerData.learnedSkills[skill.name] && window.playerData.learnedSkills[skill.name].includes(rune.name)) {
                runeNode.classList.add('learned');
            }

            // –ü–†–ê–í–ò–õ–û 3-–π –ü–†–û–§–ï–°–°–ò–ò –¥–ª—è —Ä—É–Ω
            if (hasProf3) {
                runeNode.classList.remove('dimmed');
            }
            
            if (!isAllowed) {
                runeNode.classList.add('dimmed');
            }
                            container.appendChild(runeNode);
        });
         }
    });
    
    // –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    delete window.skillTreeSectorLastNode;
}

window.getBuildStatus = function(className) {
    if (window.playerData.className !== className) return { passiveRules: {}, categoryRules: {} };
    if (!window.playerData.build || !window.playerData.class_html) return { passiveRules: {}, categoryRules: {} };

    const html = window.playerData.class_html;
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    const text = tempDiv.innerText || tempDiv.textContent;
    
    const db = window.skillDB[className];
    
         const passiveRules = {}; // { 1: {any: false, skills: []}, ... }
    const categoryRules = {}; // { 1: {any: false, skills: []}, ... }

    // –†–∞–∑–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –ü–∞—Å—Å–∏–≤–∫–∏ –∏ –ê–∫—Ç–∏–≤–∫–∏
    const parts = text.split(/–ê–ö–¢–ò–í–ö–ò:|ACTIVES:/i);
    const passiveText = parts[0] || "";
    const activeText = parts[1] || "";

    // –§—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –±–ª–æ–∫–∞ —Ç–µ–∫—Å—Ç–∞
    const parseBlock = (blockText, isPassive) => {
        // –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω: –¶–∏—Ñ—Ä–∞ + —Å–º–∞–π–ª –∫–≤–∞–¥—Ä–∞—Ç–∞ + —Ç–µ–∫—Å—Ç –¥–æ —Å–ª–µ–¥—É—é—â–µ–π —Ü–∏—Ñ—Ä—ã
        const regex = /([1-6])Ô∏è‚É£\s*([^1-6Ô∏è‚É£\n]+)/g;
        let match;
        
        while ((match = regex.exec(blockText)) !== null) {
            const num = parseInt(match[1]);
            const content = match[2];
            const hasAny = content.toLowerCase().includes("–ª—é–±–æ–µ") || content.toLowerCase().includes("any");
            
            // –ò—â–µ–º –Ω–∞–≤—ã–∫–∏ –≤ —ç—Ç–æ–º —Å–µ–≥–º–µ–Ω—Ç–µ
            const skillsFound = [];
            db.forEach(skill => {
                const sPassive = (skill.category === "–ü–∞—Å—Å–∏–≤–Ω—ã–µ");
                if (sPassive !== isPassive) return; // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç–∏–ø—É –±–ª–æ–∫–∞
                
                if (content.toLowerCase().includes(skill.name.trim().toLowerCase())) {
                    skillsFound.push(skill.name);
                }
            });

            if (isPassive) {
                if (!passiveRules[num]) passiveRules[num] = { any: false, skills: [] };
                if (hasAny) passiveRules[num].any = true;
                skillsFound.forEach(s => passiveRules[num].skills.push(s));
            } else {
                // –î–ª—è –∞–∫—Ç–∏–≤–æ–∫ –∑–∞–ø–æ–ª–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                if (!categoryRules[num]) categoryRules[num] = { any: false, skills: [] };
                if (hasAny) categoryRules[num].any = true;
                skillsFound.forEach(s => categoryRules[num].skills.push(s));
            }
        }
    };

    parseBlock(passiveText, true);
    parseBlock(activeText, false);

        return { passiveRules, categoryRules };

}

       window.drawTreeLine = function(x1, y1, x2, y2, container) {
    const length = Math.hypot(x2 - x1, y2 - y1);
    const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
    
    const line = document.createElement('div');
    line.className = 'skill-connection';
    line.style.width = `${length}px`;
    line.style.left = `${x1}px`;
    line.style.top = `${y1}px`;
    line.style.transform = `rotate(${angle}deg)`;
    container.insertBefore(line, container.firstChild); // –õ–∏–Ω–∏–∏ –ø–æ–¥ —É–∑–ª–∞–º–∏
}

       window.selectTreeSkill = function(skillIdx, nodeEl) {
    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —É–∑–ª–∞
    document.querySelectorAll('.skill-node.active').forEach(n => n.classList.remove('active'));
    if (nodeEl) nodeEl.classList.add('active');

        const cls = window.skillTreeState.currentClass;
    const skill = window.skillDB[cls][skillIdx];

     const playerLvl = window.playerData.level || 1;
    const skillUnlock = skill.unlockLevel || 1;
    
    document.getElementById('calc-skill-name').innerText = skill.name;
    document.getElementById('calc-skill-idx').value = skillIdx;
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ —Ä—É–Ω
    const runesContainer = document.getElementById('calc-runes-container');
    runesContainer.innerHTML = '';
    
    skill.runes.forEach((rune, rIdx) => {
        const btn = document.createElement('div');
        btn.className = 'rune-btn';
        btn.innerText = rune.name;
        
                const runeUnlock = rune.unlockLevel || skillUnlock;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑—É—á–µ–Ω–Ω–æ—Å—Ç–∏ —Ä—É–Ω—ã
        if (window.playerData.learnedSkills[skill.name] && window.playerData.learnedSkills[skill.name].includes(rune.name)) {
            btn.classList.add('learned');
            btn.innerHTML += ' ‚úÖ';
        }


 // –ï—Å–ª–∏ —Ä—É–Ω–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ —É—Ä–æ–≤–Ω—é
        if (playerLvl < runeUnlock) {
            btn.innerHTML += ' üîí';
            btn.style.opacity = '0.6';
        }

        btn.onclick = () => {
            document.querySelectorAll('.rune-btn.active').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('calc-rune-idx').value = rIdx;
            window.loadCalcSkillData(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—ã
        };
        runesContainer.appendChild(btn);
    });

   // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é —Ä—É–Ω—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if (runesContainer.firstChild) runesContainer.firstChild.click();
}

window.loadCalcSkillData = function() {
   const cls = window.skillTreeState.currentClass;
    const skillIdx = document.getElementById('calc-skill-idx').value;
    const runeIdx = document.getElementById('calc-rune-idx').value;
    
    const buyBtn = document.querySelector('.buy-skill-btn');
        const statsContainer = document.getElementById('calc-stats-container');

    
    if (cls && window.skillDB[cls] && window.skillDB[cls][skillIdx]) {
        const skillName = window.skillDB[cls][skillIdx].name;
        const runeName = window.skillDB[cls][skillIdx].runes[runeIdx].name;
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–∫—É–ø–∫–∏
        const playerLvl = window.playerData.level || 1;
        const skillObj = window.skillDB[cls][skillIdx];
        const runeObj = skillObj.runes[runeIdx];
        const reqLvl = runeObj.unlockLevel || skillObj.unlockLevel || 1;
        if (window.playerData.learnedSkills[skillName] && window.playerData.learnedSkills[skillName].includes(runeName)) {
            buyBtn.innerText = "–ò–ó–£–ß–ï–ù–û";
            buyBtn.disabled = true;
            buyBtn.style.background = "#333";
            buyBtn.style.color = "#aaa";
            buyBtn.style.border = "1px solid #555";
            buyBtn.style.display = "inline-block";
             } else if (playerLvl < reqLvl) {
            buyBtn.innerText = `üîí –¢–†–ï–ë–£–ï–¢–°–Ø –£–†. ${reqLvl}`;
            buyBtn.disabled = true;
            buyBtn.style.background = "#220000";
            buyBtn.style.color = "#ff4444";
            buyBtn.style.border = "1px solid #5a0000";
            buyBtn.style.display = "inline-block";
        } else {
            buyBtn.innerText = "–ò–ó–£–ß–ò–¢–¨";
            buyBtn.disabled = false;
            buyBtn.style.background = "";
            buyBtn.style.color = "";
            buyBtn.style.display = "inline-block";

            if (runeIdx == 0) {
                const learnedRunes = window.playerData.learnedSkills[skillName];
                if (learnedRunes && learnedRunes.length > 0) {
                 // buyBtn.style.display = "none"; // –ù–µ —Å–∫—Ä—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∫—É–ø–∏—Ç—å –±–∞–∑—É –µ—Å–ª–∏ –∑–∞–±—ã–ª

                }
            }
            
            const forgottenCount = window.playerData.forgottenSkills[skillName] || 0;
            if (forgottenCount > 0) {
                buyBtn.innerHTML += ` <span style="font-size:0.6rem; color:#888;">(–∑–∞–±—ã—Ç ${forgottenCount} —Ä–∞–∑)</span>`;
            }
        }
    }

    if (cls && window.skillDB[cls] && window.skillDB[cls][skillIdx]) {
        const runeData = window.skillDB[cls][skillIdx].runes[runeIdx];
        if (runeData) {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å—Ç–∞—Ç—ã –≤ HTML
            let statsHtml = '';
            
            let aoeVal = runeData.aoe || 1;
            if (aoeVal === 2.5) {
                if (cls === '–ß–∞—Ä–æ–¥–µ–π' || cls === '–ö–æ–ª–¥—É–Ω') aoeVal = 1.6;
                else if (cls === '–û—Ö–æ—Ç–Ω–∏–∫ –Ω–∞ –¥–µ–º–æ–Ω–æ–≤') aoeVal = 1.9;
            }
            
            let aoeText = `x${aoeVal}`;
            if (aoeVal === 1) aoeText = "–û–¥–∏–Ω–æ—á–Ω–∞—è (—Ö1)";
            else if (aoeVal === 1.3) aoeText = "–ú–∞–ª–∞—è –≥—Ä—É–ø–ø–∞ (—Ö1.3)";
            else if (aoeVal === 1.5) aoeText = "–õ–∏–Ω–∏—è (—Ö1.5)";
            else if (aoeVal === 1.75) aoeText = "–ö–æ–Ω—É—Å (—Ö1.75)";
            else if (aoeVal === 1.9) {
                if (cls === '–û—Ö–æ—Ç–Ω–∏–∫ –Ω–∞ –¥–µ–º–æ–Ω–æ–≤') aoeText = "–í –ª—é–±—É—é —Ç–æ—á–∫—É (—Ö1.9)";
                else aoeText = "–°—Ä–µ–¥–Ω—è—è (—Ö1.9)";
            }
            else if (aoeVal === 2) aoeText = "–í–æ–∫—Ä—É–≥ (—Ö2)";
            else if (aoeVal === 2.5) aoeText = "–í –ª—é–±—É—é —Ç–æ—á–∫—É (—Ö2.5)";
            else if (aoeVal === 1.6) aoeText = "–í –ª—é–±—É—é —Ç–æ—á–∫—É (—Ö1.6)";

                           if (runeData.dmg) statsHtml += `<div class="stat-row-calc"><span class="stat-label">‚öîÔ∏è –£—Ä–æ–Ω:</span> <span class="stat-val">${runeData.dmg}%</span></div>`;
            statsHtml += `<div class="stat-row-calc"><span class="stat-label">üéØ –û–±–ª–∞—Å—Ç—å:</span> <span class="stat-val">${aoeText}</span></div>`;
            if (runeData.slow) statsHtml += `<div class="stat-row-calc"><span class="stat-label">‚ùÑÔ∏è –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ:</span> <span class="stat-val">${runeData.slow}%</span></div>`;
            if (runeData.stun) statsHtml += `<div class="stat-row-calc"><span class="stat-label">‚ö° –ö–æ–Ω—Ç—Ä–æ–ª—å:</span> <span class="stat-val">${runeData.stun} —Å–µ–∫</span></div>`;
            if (runeData.heal) statsHtml += `<div class="stat-row-calc"><span class="stat-label">‚ù§Ô∏è –õ–µ—á–µ–Ω–∏–µ:</span> <span class="stat-val">${runeData.heal}% HP</span></div>`;
            if (runeData.buffDmg) statsHtml += `<div class="stat-row-calc"><span class="stat-label">üõ°Ô∏è –ë–∞—Ñ—Ñ –£—Ä–æ–Ω–∞:</span> <span class="stat-val">${runeData.buffDmg}%</span></div>`;
            if (runeData.buffDef) statsHtml += `<div class="stat-row-calc"><span class="stat-label">üõ°Ô∏è –ë–∞—Ñ—Ñ –ó–∞—â–∏—Ç—ã:</span> <span class="stat-val">${runeData.buffDef}%</span></div>`;
            if (runeData.effInc) statsHtml += `<div class="stat-row-calc"><span class="stat-label">‚ö° –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</span> <span class="stat-val">${runeData.effInc}%</span></div>`;
            if (runeData.resGain) statsHtml += `<div class="stat-row-calc"><span class="stat-label">üåÄ –†–µ—Å—É—Ä—Å:</span> <span class="stat-val">${runeData.resGain}</span></div>`;
            
            statsContainer.innerHTML = statsHtml;

            
            document.getElementById('calc-buff-perm').value = runeData.buffPerm ? "true" : "false";
            document.getElementById('calc-buff-duration').value = runeData.buffDuration || 0;
            document.getElementById('calc-dmg-amp').value = runeData.dmgAmp || 0;
            document.getElementById('calc-cost-red-flat').value = runeData.costRedFlat || 0;
            document.getElementById('calc-dmg-2').value = runeData.dmg2 || 0;
            document.getElementById('calc-aoe-2').value = runeData.aoe2 || 1;
            
            const synergyBox = document.getElementById('calc-synergy-box');
            if (runeData.dmgAmp > 0) {
                synergyBox.style.display = 'block';
                const synSelect = document.getElementById('calc-synergy-skill');
                
                synSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–≤—ã–∫ --</option>';
                window.skillDB[cls].forEach((s, i) => {
                    s.runes.forEach((r, ri) => {
                        if (r.dmg > 0) {
                            if (runeData.elemSynergy && !r.name.includes(runeData.elemSynergy)) return;
                            if (runeData.synergyCD) {
                                const desc = (r.desc || "").toLowerCase();
                                if (!desc.includes("–≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è") && !desc.includes("–∫–¥")) return;
                            }
                            synSelect.innerHTML += `<option value="${i}-${ri}">${s.name} - ${r.name} (${r.dmg}%)</option>`;
                        }
                    });
                });
            } else {
                synergyBox.style.display = 'none';
            }

            let blockBox = document.getElementById('calc-block-box');
            if (!blockBox) {
                const synergyBox = document.getElementById('calc-synergy-box');
                if (synergyBox && synergyBox.parentNode) {
                    blockBox = document.createElement('div');
                    blockBox.id = 'calc-block-box';
                    blockBox.style.display = 'none';
                    blockBox.style.marginTop = '10px';
                    blockBox.innerHTML = `<label style="color:#d4af37;">üõ°Ô∏è –®–∞–Ω—Å –±–ª–æ–∫–∞ (%): <input type="number" id="calc-block-chance" value="20" style="width:50px; background:#000; color:#fff; border:1px solid #444; text-align:center;" oninput="window.calculateSkillCost()"></label>`;
                    synergyBox.parentNode.insertBefore(blockBox, synergyBox.nextSibling);
                }
            }
            if (blockBox) {
                blockBox.style.display = (runeData.blockDmg > 0) ? 'block' : 'none';
            }
            
            const skillName = window.skillDB[cls][skillIdx].name;
            const runeName = window.skillDB[cls][skillIdx].runes[runeIdx].name;
            document.getElementById('calc-skill-cost-box').style.display = (runeName === "–ü—Ä–∏–∑–º–∞" || runeName === "–°–∏–ª–∞ –±—É—Ä–∏") ? 'block' : 'none';

        } else {
            document.getElementById('calc-skill-cost-box').style.display = 'none';
            document.getElementById('calc-synergy-box').style.display = 'none';
        }
    }
    window.calculateSkillCost();
}

window.calculateRuneCostFromDB = function(className, skillIdx, runeIdx) {
    if (!window.skillDB[className] || !window.skillDB[className][skillIdx]) return { cost: 0, details: [] };
    
    const runeData = window.skillDB[className][skillIdx].runes[runeIdx];
    if (!runeData) return { cost: 0, details: [] };

    const isPassive = window.skillDB[className][skillIdx].category === "–ü–∞—Å—Å–∏–≤–Ω—ã–µ";

    const dmg = runeData.dmg || 0;
    let aoeMult = runeData.aoe || 1;
    
    if (isPassive) {
        if (className === '–ß–∞—Ä–æ–¥–µ–π' || className === '–ö–æ–ª–¥—É–Ω') aoeMult = 1.6;
        else if (className === '–û—Ö–æ—Ç–Ω–∏–∫ –Ω–∞ –¥–µ–º–æ–Ω–æ–≤') aoeMult = 1.9;
        else aoeMult = 2.5;
    } else if (aoeMult === 2.5) {
        if (className === '–ß–∞—Ä–æ–¥–µ–π' || className === '–ö–æ–ª–¥—É–Ω') aoeMult = 1.6;
        else if (className === '–û—Ö–æ—Ç–Ω–∏–∫ –Ω–∞ –¥–µ–º–æ–Ω–æ–≤') aoeMult = 1.9;
    }

    const slow = runeData.slow || 0;
    const stun = runeData.stun || 0;
    const heal = runeData.heal || 0;
    const buffDmg = runeData.buffDmg || 0;
    const effInc = runeData.effInc || 0;
    const resGain = runeData.resGain || 0;
    const isBuffPerm = runeData.buffPerm || false;
    const buffDuration = runeData.buffDuration || 0;
    const dmgAmp = runeData.dmgAmp || 0;
    const costRedFlat = runeData.costRedFlat || 0;
    const dmg2 = runeData.dmg2 || 0;
    let aoe2 = runeData.aoe2 || 1;
    const isSynergyCD = runeData.synergyCD || false;
    const isBuffAoe = runeData.buffIsAoe || false;
    const passiveDmg = runeData.passiveDmg || 0;
    const passiveSlow = runeData.passiveSlow || 0;
    const blockDmg = runeData.blockDmg || 0;
    const thornsDmg = runeData.thornsDmg || 0;
    
    const mainSkillCost = parseFloat(document.getElementById('calc-main-skill-cost').value) || 0;
    const synVal = document.getElementById('calc-synergy-skill').value;
    
    const meleeClasses = ["–í–∞—Ä–≤–∞—Ä", "–ú–æ–Ω–∞—Ö", "–ö—Ä–µ—Å—Ç–æ–Ω–æ—Å–µ—Ü"];
    const rangedClasses = ["–ß–∞—Ä–æ–¥–µ–π", "–ö–æ–ª–¥—É–Ω", "–û—Ö–æ—Ç–Ω–∏–∫ –Ω–∞ –¥–µ–º–æ–Ω–æ–≤"];
    const isMelee = meleeClasses.includes(className);
    const isRanged = rangedClasses.includes(className);
    
    let controlMult = 1;
    let slowMult = 1;

    if (isMelee) { controlMult = 2.5; slowMult = 0; }
    else if (isRanged) { slowMult = 1.5; }

    let cost = 0;
    let details = [];

    let totalEffInc = effInc;
    if (costRedFlat > 0 && mainSkillCost > costRedFlat) {
        let newCost = mainSkillCost - costRedFlat;
        let ratio = mainSkillCost / newCost;
        let addedEff = (ratio - 1) * 100;
        totalEffInc += addedEff;
        details.push(`–≠—Ñ—Ñ. –æ—Ç —Å–Ω–∏–∂. –∑–∞—Ç—Ä–∞—Ç (${mainSkillCost} -> ${newCost}): +${addedEff.toFixed(1)}%`);
    }

    let cooldown = 0;
    if (!runeData.noCdDiscount) {
        const descText = runeData.desc || "";
        let cdMatch = descText.match(/(?:–í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è|–ö–î)[^0-9]*(\d+(?:\.\d+)?) —Å–µ–∫/i);
        if (!cdMatch && runeIdx != 0) {
            const baseRune = window.skillDB[className][skillIdx].runes[0];
            if (baseRune && baseRune.desc) {
                cdMatch = baseRune.desc.match(/(?:–í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è|–ö–î)[^0-9]*(\d+(?:\.\d+)?) —Å–µ–∫/i);
            }
        }
        if (cdMatch) {
            cooldown = parseFloat(cdMatch[1]);
        }
    }
    const cdDiscount = 1 + (cooldown * 0.1);
    
    // –ü–∞—Ä—Å–∏–Ω–≥ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è DoT (–£—Ä–æ–Ω —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º)
    let duration = 0;
    const descText = runeData.desc || "";
    // –ò—â–µ–º "–≤ —Ç–µ—á–µ–Ω–∏–µ X —Å–µ–∫" –∏–ª–∏ "–∑–∞ X —Å–µ–∫"
    let durMatch = descText.match(/(?:–≤ —Ç–µ—á–µ–Ω–∏–µ|–∑–∞)\s*(\d+(?:\.\d+)?)\s*—Å–µ–∫/i);
    if (durMatch) {
        duration = parseFloat(durMatch[1]);
    }

    if (dmg > 0) {
        let baseDmgCost = (dmg / 100) * 2 * aoeMult;
        if (cooldown > 0) baseDmgCost /= cdDiscount;

        let finalDmgCost = baseDmgCost;
        let formula = `–£—Ä–æ–Ω (${dmg}% / 100 * 2 [–ë–∞–∑–∞] * ${aoeMult} [AOE])`;
        
        // –ù–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è DoT (DPS + –ú–Ω–æ–∂–∏—Ç–µ–ª–∏ –≤—Ä–µ–º–µ–Ω–∏)
        if (duration > 0) {
            const dps = dmg / duration;
            let timeMult = 1;
            if (duration >= 15) timeMult = 2;
            else if (duration >= 10) timeMult = 3;
            else if (duration >= 5) timeMult = 4;
            
            baseDmgCost = (dps / 100) * 2 * aoeMult * timeMult;
            if (cooldown > 0) baseDmgCost /= cdDiscount;
            
            finalDmgCost = baseDmgCost;
            formula = `DoT (${dps.toFixed(1)}% DPS / 100 * 2 * ${aoeMult} [AOE] * ${timeMult} [–í—Ä–µ–º—è ${duration}—Å])`;
        }

        if (cooldown > 0) formula += ` / ${cdDiscount.toFixed(1)} [–ö–î]`;

        if (totalEffInc > 0) {
            formula += ` * (1 + ${totalEffInc.toFixed(0)}%/100 [–≠—Ñ—Ñ])`;
            finalDmgCost = baseDmgCost * (1 + totalEffInc / 100);
        }
        
        cost += finalDmgCost;
        details.push(`${formula} = ${finalDmgCost.toFixed(2)}`);
    }

    if (blockDmg > 0) {
        const blockChance = parseFloat(document.getElementById('calc-block-chance')?.value) || 0;
        const addedDmg = blockDmg * (blockChance / 100);
        
        let blockCost = (addedDmg / 100) * 2 * aoeMult;
        if (cooldown > 0) blockCost /= cdDiscount;
        
        if (totalEffInc > 0) {
            blockCost = blockCost * (1 + totalEffInc / 100);
        }
        
        cost += blockCost;
        details.push(`–£—Ä–æ–Ω –æ—Ç –ë–ª–æ–∫–∞ (${blockDmg}% –æ—Ç ${blockChance}% –ë–ª–æ–∫–∞ = ${addedDmg.toFixed(1)}% / 100 * 2 * ${aoeMult} [AOE]) = ${blockCost.toFixed(2)}`);
    }

    if (thornsDmg > 0) {
        let thornsCost = (thornsDmg / 100) * 2 * aoeMult;
        let formula = `–£—Ä–æ–Ω –æ—Ç –®–∏–ø–æ–≤ (${thornsDmg}% / 100 * 2 * ${aoeMult} [AOE])`;

        if (cooldown > 0) {
            thornsCost /= cdDiscount;
            formula += ` / ${cdDiscount.toFixed(1)} [–ö–î]`;
        }
        if (totalEffInc > 0) {
            thornsCost *= (1 + totalEffInc / 100);
        }
        cost += thornsCost;
        details.push(`${formula} = ${thornsCost.toFixed(2)}`);
    }

    if (dmg2 > 0) {
        if (aoe2 === 2.5) {
            if (className === "–ß–∞—Ä–æ–¥–µ–π" || className === "–ö–æ–ª–¥—É–Ω") aoe2 = 1.6;
            else if (className === "–û—Ö–æ—Ç–Ω–∏–∫ –Ω–∞ –¥–µ–º–æ–Ω–æ–≤") aoe2 = 1.9;
        }
        let dmg2Cost = (dmg2 / 100) * 2 * aoe2;
        if (cooldown > 0) dmg2Cost /= cdDiscount;
        
        if (totalEffInc > 0) {
            dmg2Cost = dmg2Cost * (1 + totalEffInc / 100);
            details.push(`–î–æ–ø. –£—Ä–æ–Ω (${dmg2}%${cooldown > 0 ? ' / ' + cdDiscount.toFixed(1) + ' [–ö–î]' : ''}) * (1 + ${totalEffInc.toFixed(0)}% [–≠—Ñ—Ñ]) = ${dmg2Cost.toFixed(2)}`);
        } else {
            details.push(`–î–æ–ø. –£—Ä–æ–Ω (${dmg2}% / 100 * 2 [–ë–∞–∑–∞] * ${aoe2} [AOE]${cooldown > 0 ? ' / ' + cdDiscount.toFixed(1) + ' [–ö–î]' : ''}) = ${dmg2Cost.toFixed(2)}`);
        }
        cost += dmg2Cost;
    }

    if (passiveDmg > 0) {
        let val = (passiveDmg / 100) * 2;
        cost += val;
        details.push(`–ü–∞—Å—Å–∏–≤–Ω—ã–π –£—Ä–æ–Ω (${passiveDmg}% / 100 * 2) = ${val.toFixed(2)}`);
    }

    if (passiveSlow > 0) {
        let baseVal = (passiveSlow / 20) * 4;
        let val = baseVal * slowMult;
        cost += val;
        let formula = `–ü–∞—Å—Å–∏–≤–Ω–æ–µ –ó–∞–º–µ–¥–ª. (${passiveSlow}% / 20 * 4 [–ü–æ—Å—Ç])`;
        if (slowMult !== 1) formula += ` * ${slowMult} [–ö–ª–∞—Å—Å]`;
        details.push(`${formula} = ${val.toFixed(2)}`);
    }

    if (slow > 0) { 
        let baseSlowCost = slow / 20;
        let val = baseSlowCost * aoeMult * slowMult;
        cost += val; 
        let formula = `–ó–∞–º–µ–¥–ª (${slow}% / 20 [–ë–∞–∑–∞])`;
        if (aoeMult !== 1) formula += ` * ${aoeMult} [AOE]`;
        if (slowMult !== 1) formula += ` * ${slowMult} [–ö–ª–∞—Å—Å]`;
        details.push(`${formula} = ${val.toFixed(2)}`); 
    }
    if (stun > 0) { 
        let val = stun * aoeMult * controlMult;
        cost += val; 
        let formula = `–°—Ç–∞–Ω (${stun}—Å * 1 [–¶–µ–Ω–∞/—Å])`;
        if (aoeMult !== 1) formula += ` * ${aoeMult} [AOE]`;
        if (controlMult !== 1) formula += ` * ${controlMult} [–ö–ª–∞—Å—Å]`;
        details.push(`${formula} = ${val.toFixed(2)}`); 
    }

    if (heal > 0) { 
        let val = (heal / 5) * 2;
        if (cooldown > 0) val /= cdDiscount;
        let desc = `–õ–µ—á–µ–Ω–∏–µ/–©–∏—Ç (${heal}% / 5 [–ë–∞–∑–∞] * 2 [–ú–Ω–æ–∂])`;
        if (cooldown > 0) desc += ` / ${cdDiscount.toFixed(1)} [–ö–î]`;

        if (isBuffAoe) {
            val *= 0.75;
            desc += ` * 0.75 [–ö–æ–º–∞–Ω–¥–Ω—ã–π]`;
            let costFor2nd = val / 3;
            if (dmg === 0 && dmg2 === 0 && totalEffInc > 0) {
                costFor2nd *= (1 + totalEffInc / 100);
            }
            cost += val;
            details.push(`${desc} = ${val.toFixed(2)}`);
            details.push(`<span style="color:#ff7979; font-weight:bold; margin-left:10px;">üë§ 2-–π –∏–≥—Ä–æ–∫ –ø–ª–∞—Ç–∏—Ç: ${costFor2nd.toFixed(2)} üìñ</span>`);
        } else {
            cost += val; 
            details.push(`${desc} = ${val.toFixed(2)}`); 
        }
    }

    if (buffDmg > 0) { 
        let multiplier = isBuffPerm ? 4 : 2;
        if (isPassive) multiplier = 5;
        let val = (buffDmg / 10) * multiplier;
        if (isPassive) val *= aoeMult;
        cost += val; 
        let formula = "";
        if (isPassive) {
            formula = `–ë–∞—Ñ—Ñ –£—Ä–æ–Ω–∞ (${buffDmg}% * 0.5 [–ü–∞—Å—Å–∏–≤–∫–∞])`;
        } else {
            formula = `–ë–∞—Ñ—Ñ –£—Ä–æ–Ω–∞ (${buffDmg}% / 10 [–ë–∞–∑–∞] * ${multiplier} [–¢–∏–ø])`;
        }
        if (isPassive) formula += ` * ${aoeMult} [AOE]`;
        details.push(`${formula} = ${val.toFixed(2)}`); 
    }

    const defBuffs = [
        { val: runeData.buffDef || 0, type: runeData.defType || "" },
        { val: runeData.buffDef2 || 0, type: runeData.defType2 || "" },
        { val: runeData.buffDef3 || 0, type: runeData.defType3 || "" }
    ];

    defBuffs.forEach((buff, idx) => {
        if (buff.val > 0) {
            let multiplier = 1;
            if (isBuffPerm) multiplier = 4;
            else if (buffDuration >= 10 && buffDuration <= 20) multiplier = 2;
            else multiplier = 1;
            if (isPassive) multiplier = 3.75;

            let val = (buff.val / 5) * multiplier;
            let typeMult = 1;
            let typeName = "";
            
            if (buff.type === "res") {
                if (className === "–ß–∞—Ä–æ–¥–µ–π" || className === "–ö–æ–ª–¥—É–Ω") typeMult = 1;
                else typeMult = 1.5;
                typeName = " [–°–æ–ø—Ä–æ—Ç]";
            } else if (buff.type === "armor") {
                if (className === "–í–∞—Ä–≤–∞—Ä" || className === "–ö—Ä–µ—Å—Ç–æ–Ω–æ—Å–µ—Ü") typeMult = 1;
                else typeMult = 1.5;
                typeName = " [–ë—Ä–æ–Ω—è]";
            } else if (buff.type === "dodge") {
                if (className === "–ú–æ–Ω–∞—Ö" || className === "–û—Ö–æ—Ç–Ω–∏–∫ –Ω–∞ –¥–µ–º–æ–Ω–æ–≤") typeMult = 1;
                else typeMult = 1.5;
                typeName = " [–£–∫–ª–æ–Ω]";
            }

            val *= typeMult;
            if (isBuffAoe) val *= 0.75;

            cost += val; 
            let desc = "";
            if (isPassive) {
                desc = `–ë–∞—Ñ—Ñ –ó–∞—â–∏—Ç—ã ${idx+1} (${buff.val}% * 0.75 [–ü–∞—Å—Å–∏–≤–∫–∞]${typeMult > 1 ? ' * ' + typeMult + typeName : ''})`;
            } else {
                desc = `–ë–∞—Ñ—Ñ –ó–∞—â–∏—Ç—ã ${idx+1} (${buff.val}% / 5 [–ë–∞–∑–∞] * ${multiplier} [–¢–∏–ø]${typeMult > 1 ? ' * ' + typeMult + typeName : ''})`;
            }
            if (isBuffAoe) {
                desc += ` * 0.75 [–ö–æ–º–∞–Ω–¥–Ω—ã–π]`;
                let costFor2nd = val / 3;
                if (dmg === 0 && dmg2 === 0 && totalEffInc > 0) {
                    costFor2nd *= (1 + totalEffInc / 100);
                }
                details.push(`${desc} = ${val.toFixed(2)}`);
                details.push(`<span style="color:#ff7979; font-weight:bold; margin-left:10px;">üë§ 2-–π –∏–≥—Ä–æ–∫ –ø–ª–∞—Ç–∏—Ç: ${costFor2nd.toFixed(2)} üìñ</span>`);
            } else {
                details.push(`${desc} = ${val.toFixed(2)}`); 
            }
        }
    });

    const maxResources = { "–ß–∞—Ä–æ–¥–µ–π": 100, "–ö–æ–ª–¥—É–Ω": 750, "–ú–æ–Ω–∞—Ö": 250, "–í–∞—Ä–≤–∞—Ä": 100, "–ö—Ä–µ—Å—Ç–æ–Ω–æ—Å–µ—Ü": 100, "–û—Ö–æ—Ç–Ω–∏–∫ –Ω–∞ –¥–µ–º–æ–Ω–æ–≤": 125 };
    if (resGain > 0 && maxResources[className]) {
        const maxRes = maxResources[className];
        const resGainPercent = (resGain / maxRes) * 100;
        
        let val = 0;
        let formula = "";
        
        if (runeData.resGainInstant) {
            val = (resGainPercent / 5) * 1; // 5% = 1 —Ä—É–Ω–∞ (–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ)
            formula = `–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç. (${resGain} / ${maxRes} = ${resGainPercent.toFixed(1)}% / 5 [–ë–∞–∑–∞])`;
        } else {
            val = (resGainPercent / 2) * 1; // 2% = 1 —Ä—É–Ω–∞ (–û–±—ã—á–Ω–æ–µ)
            formula = `–í–æ—Å—Å—Ç. —Ä–µ—Å—É—Ä—Å–∞ (${resGain} / ${maxRes} = ${resGainPercent.toFixed(1)}% / 2 [–ë–∞–∑–∞])`;
        }

        cost += val;
        details.push(`${formula} = ${val.toFixed(2)}`);
    }

    if (runeData.customCost !== undefined) {
        let cc = runeData.customCost;
        let desc = runeData.customCostDesc || `–î–æ–ø. —ç—Ñ—Ñ–µ–∫—Ç`;
        if (isBuffAoe && cc > 0) {
            let val = cc * 0.75;
            cost += val;
            details.push(`${desc}: ${cc} * 0.75 [–ö–æ–º–∞–Ω–¥–Ω—ã–π] = ${val.toFixed(2)}`);
            let costFor2nd = val / 3;
            if (dmg === 0 && dmg2 === 0 && totalEffInc > 0) costFor2nd *= (1 + totalEffInc / 100);
            details.push(`<span style="color:#ff7979; font-weight:bold; margin-left:10px;">üë§ 2-–π –∏–≥—Ä–æ–∫ –ø–ª–∞—Ç–∏—Ç: ${costFor2nd.toFixed(2)} üìñ</span>`);
        } else {
            cost += cc;
            details.push(`${desc}: ${cc}`);
        }
    }

    const skillName = window.skillDB[className][skillIdx].name;
    const runeName = window.skillDB[className][skillIdx].runes[runeIdx].name;
    if (skillName === "–ê—Ä—Ö–æ–Ω—Ç" && runeName.includes("–ó–∞–º–µ–¥–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏")) {
        const slowTimeLearned = window.playerData.learnedSkills["–ó–∞–º–µ–¥–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏"];
        if (!slowTimeLearned || slowTimeLearned.length === 0) {
            cost += 7.20;
            details.push(`–í–∫–ª. –Ω–∞–≤—ã–∫ "–ó–∞–º–µ–¥–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏" (–Ω–µ –∏–∑—É—á–µ–Ω): 7.20`);
        }
    }

    if (dmgAmp > 0) {
        if (synVal) {
            const [sIdx, rIdx] = synVal.split('-');
            const targetRune = window.skillDB[className][sIdx].runes[rIdx];
            const tDmg = targetRune.dmg || 0;
            let tAoe = targetRune.aoe || 1;
            if (tAoe === 2.5) {
                if (className === "–ß–∞—Ä–æ–¥–µ–π" || className === "–ö–æ–ª–¥—É–Ω") tAoe = 1.6;
                else if (className === "–û—Ö–æ—Ç–Ω–∏–∫ –Ω–∞ –¥–µ–º–æ–Ω–æ–≤") tAoe = 1.9;
            }

            if (tDmg > 0) {
                const targetCost = (tDmg / 100) * 2 * tAoe;
                if (isSynergyCD) {
                    const addedCost = targetCost * (dmgAmp / 100);
                    cost += addedCost;
                    details.push(`–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ö–î: ${targetCost.toFixed(2)} [–¶–µ–Ω–∞ —Ü–µ–ª–∏] * ${dmgAmp}% = ${addedCost.toFixed(2)}`);
                } else {
                    let multiplier = 1;
                    if (isBuffPerm) multiplier = 4;
                    else if (buffDuration >= 10 && buffDuration <= 20) multiplier = 2;
                    const part1 = targetCost * (dmgAmp / 100);
                    const part2 = (dmgAmp / 10) * multiplier;
                    const addedCost = part1 + part2;
                    cost += addedCost;
                    details.push(`–°–∏–Ω–µ—Ä–≥–∏—è: (${targetCost.toFixed(2)} [–¶–µ–Ω–∞ —Ü–µ–ª–∏] * ${dmgAmp}% [–£—Å–∏–ª]) + (${(dmgAmp/10*multiplier).toFixed(1)} [–ë–∞—Ñ—Ñ]) = ${addedCost.toFixed(2)}`);
                }
            }
        } else {
            details.push(`<span style="color:#ff4444">‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–≤—ã–∫ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å–∏–Ω–µ—Ä–≥–∏–∏!</span>`);
        }
    }

    if (dmg === 0 && dmg2 === 0 && totalEffInc > 0) {
        let oldCost = cost;
        cost = cost * (1 + totalEffInc / 100);
        details.push(`–û–±—â–∞—è –≠—Ñ—Ñ.: ${oldCost.toFixed(2)} * (1 + ${totalEffInc.toFixed(0)}%/100 [–≠—Ñ—Ñ]) = ${cost.toFixed(2)}`);
    }
    
    // –†–∞—Å—á–µ—Ç –º–Ω–æ–∂–∏—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Ä—è–¥–∫–∞ –∏–∑—É—á–µ–Ω–∏—è (learnedSkillsOrder)
    if (!window.playerData.learnedSkillsOrder) {
        window.playerData.learnedSkillsOrder = Object.keys(window.playerData.learnedSkills || {});
    }

    const isLearned = window.playerData.learnedSkills && window.playerData.learnedSkills[skillName];
    let relevantIndex = 0;
    
    for (const sName of window.playerData.learnedSkillsOrder) {
        if (isLearned && sName === skillName) break; // –î–æ—à–ª–∏ –¥–æ —Ç–µ–∫—É—â–µ–≥–æ –Ω–∞–≤—ã–∫–∞
        
        const sObj = window.skillDB[className].find(s => s.name === sName);
        if (sObj) {
            const sPassive = sObj.category === "–ü–∞—Å—Å–∏–≤–Ω—ã–µ";
            if (sPassive === isPassive) {
                relevantIndex++;
            }
        }
    }

    // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å–≤–µ—Ä—Ö –ª–∏–º–∏—Ç–∞ (6 –∞–∫—Ç–∏–≤–Ω—ã—Ö, 4 –ø–∞—Å—Å–∏–≤–Ω—ã—Ö)
    const activeSoftCap = 6;
    const passiveSoftCap = 4;

    if (!isPassive && relevantIndex >= activeSoftCap) {
        const excess = relevantIndex - activeSoftCap + 1;
        const mult = Math.pow(1.3, excess);
        let oldCost = cost;
        cost *= mult;
        details.push(`<span style="color:#ffcc00">‚ö†Ô∏è –î–æ–ø. –Ω–∞–≤—ã–∫ (${excess}-–π —Å–≤–µ—Ä—Ö –ª–∏–º–∏—Ç–∞): ${oldCost.toFixed(2)} * ${mult.toFixed(2)} = ${cost.toFixed(2)}</span>`);
    } else if (isPassive && relevantIndex >= passiveSoftCap) {
        const excess = relevantIndex - passiveSoftCap + 1;
        const mult = Math.pow(1.3, excess);
        let oldCost = cost;
        cost *= mult;
        details.push(`<span style="color:#ffcc00">‚ö†Ô∏è –î–æ–ø. –ø–∞—Å—Å–∏–≤–∫–∞ (${excess}-—è —Å–≤–µ—Ä—Ö –ª–∏–º–∏—Ç–∞): ${oldCost.toFixed(2)} * ${mult.toFixed(2)} = ${cost.toFixed(2)}</span>`);
    }

    return { cost: cost, details: details };
}

window.calculateSkillCost = function() {
    const className = window.skillTreeState.currentClass;
    const skillIdx = document.getElementById('calc-skill-idx').value;
    const runeIdx = document.getElementById('calc-rune-idx').value;

    if (!className || skillIdx === '' || runeIdx === '') return;

    const currentCalc = window.calculateRuneCostFromDB(className, skillIdx, runeIdx);
    let finalCost = currentCalc.cost;
    let details = currentCalc.details;

    const skillName = window.skillDB[className][skillIdx].name;
    const learnedRunes = window.playerData.learnedSkills[skillName];
    const isAnyRuneLearned = learnedRunes && learnedRunes.length > 0;

    if (isAnyRuneLearned) {
        const baseCalc = window.calculateRuneCostFromDB(className, skillIdx, 0);
        if (baseCalc.cost > 0) {
            finalCost = Math.max(0, finalCost - baseCalc.cost);
            details.push(`<br><span style="color:#66ff66">‚úÖ –°–∫–∏–¥–∫–∞ –∑–∞ –∏–∑—É—á–µ–Ω–Ω—ã–π –Ω–∞–≤—ã–∫: -${baseCalc.cost.toFixed(2)}</span>`);
        }
    }

    document.getElementById('calc-result').innerText = finalCost.toFixed(2);
    document.getElementById('calc-details').innerHTML = details.join('<br>') || "–ù–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤";
}

window.buySkill = function() {
    const cost = parseFloat(document.getElementById('calc-result').innerText);
    const className = window.skillTreeState.currentClass;
    const skillIdx = document.getElementById('calc-skill-idx').value;
    const runeIdx = document.getElementById('calc-rune-idx').value;

    if (!className || skillIdx === '' || runeIdx === '') {
        window.showCustomAlert("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å, –Ω–∞–≤—ã–∫ –∏ —Ä—É–Ω—É.");
        return;
    }

    const runeData = window.skillDB[className][skillIdx].runes[runeIdx];
    if (runeData.dmgAmp > 0) {
        const synVal = document.getElementById('calc-synergy-skill').value;
        if (!synVal) {
            window.showCustomAlert("‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–≤—ã–∫ –¥–ª—è —Å–∏–Ω–µ—Ä–≥–∏–∏!");
            return;
        }
    }

    if (!window.playerData.className || window.playerData.className === "–ö–ª–∞—Å—Å –Ω–µ –≤—ã–±—Ä–∞–Ω") {
        window.showCustomAlert("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å (–±–∏–ª–¥) –≤ –º–µ–Ω—é –ö–ª–∞—Å—Å–æ–≤.");
        return;
    }

    if (window.playerData.className && window.playerData.className !== "–ö–ª–∞—Å—Å –Ω–µ –≤—ã–±—Ä–∞–Ω") {
        if (window.playerData.className !== className) {
             window.showCustomAlert(`‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∏–∑—É—á–∏—Ç—å –Ω–∞–≤—ã–∫ –∫–ª–∞—Å—Å–∞ <span style="color:#d4af37"></span>.<br><br>–í–∞—à –∫–ª–∞—Å—Å: <span style="color:#66ccff">${window.playerData.className}</span>.`);
             return;
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–æ –±–∏–ª–¥—É (–µ—Å–ª–∏ –Ω–µ—Ç 3-–π –ø—Ä–æ—Ñ—ã)
    const hasProf3 = window.playerData.professions && window.playerData.professions[3];
    if (!hasProf3) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞—Ç–µ–º–Ω–µ–Ω –ª–∏ —É–∑–µ–ª –≤ –¥–µ—Ä–µ–≤–µ (—Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±, —Ç–∞–∫ –∫–∞–∫ –ª–æ–≥–∏–∫–∞ —É–∂–µ —Ç–∞–º)
        // –ù–æ —É –Ω–∞—Å –Ω–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ —É–∑–µ–ª –∑–¥–µ—Å—å. –ü–æ–≤—Ç–æ—Ä–∏–º –ª–æ–≥–∏–∫—É –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏–º –∫–ª–∞—Å—Å.
        // –õ—É—á—à–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ getBuildStatus, —Ç–∞–∫ –Ω–∞–¥–µ–∂–Ω–µ–µ.
        // –ù–æ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏: –µ—Å–ª–∏ –º—ã —Å–º–æ–≥–ª–∏ –∫–ª–∏–∫–Ω—É—Ç—å –Ω–∞ —É–∑–µ–ª, –∑–Ω–∞—á–∏—Ç –æ–Ω –±—ã–ª –¥–æ—Å—Ç—É–ø–µ–Ω?
        // –ù–ï–¢, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –∫–ª–∏–∫–Ω—É—Ç—å, –ø–æ—Ç–æ–º –≤—ã—É—á–∏—Ç—å –¥—Ä—É–≥–æ–π –Ω–∞–≤—ã–∫, –∏ —ç—Ç–æ—Ç —Å—Ç–∞–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ –ø–∞–Ω–µ–ª—å –æ—Ç–∫—Ä—ã—Ç–∞.
        // –ü–æ—ç—Ç–æ–º—É –Ω—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞.
        
        // –≠–º—É–ª—è—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏: –µ—Å–ª–∏ –±—ã –º—ã —Ä–∏—Å–æ–≤–∞–ª–∏ –¥–µ—Ä–µ–≤–æ, –±—ã–ª –±—ã —ç—Ç–æ—Ç –Ω–∞–≤—ã–∫ dimmed?
        // –≠—Ç–æ —Å–ª–æ–∂–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å. –ü—Ä–æ—â–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å: –µ—Å—Ç—å –ª–∏ —É –Ω–∞–≤—ã–∫–∞ –∫–ª–∞—Å—Å 'dimmed' –≤ DOM?
        const activeNode = document.querySelector('.skill-node.active');
        if (activeNode && activeNode.classList.contains('dimmed')) {
            window.showCustomAlert("‚ùå –≠—Ç–æ—Ç –Ω–∞–≤—ã–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–∏–ª–¥–∞.");
            return;
        }
    }

    const validationError = window.validateSkillCost(className, skillIdx, runeIdx);
    if (validationError) {
        window.showCustomConfirm(
            `‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ —Ä–∞—Å—á–µ—Ç–∞—Ö!<br><br><span style="color:#ffcc00;"></span><br><br>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫—É?`,
            () => proceedWithPurchase()
        );
    } else {
        proceedWithPurchase();
    }
}

window.proceedWithPurchase = function() {
    const cost = parseFloat(document.getElementById('calc-result').innerText);
    const className = window.skillTreeState.currentClass;
    const skillIdx = document.getElementById('calc-skill-idx').value;
    const runeIdx = document.getElementById('calc-rune-idx').value;

    const skillName = window.skillDB[className][skillIdx].name;
    const runeName = window.skillDB[className][skillIdx].runes[runeIdx].name;

    if (window.playerData.learnedSkills[skillName] && window.playerData.learnedSkills[skillName].includes(runeName)) {
        window.showCustomAlert(`‚úÖ –ù–∞–≤—ã–∫ "${skillName} (${runeName})" —É–∂–µ –∏–∑—É—á–µ–Ω.`);
        return;
    }
    
    let maxActive = 1;
    if (window.playerData.professions[1]) maxActive += 2;
    if (window.playerData.professions[2]) maxActive += 2;
    if (window.playerData.professions[3]) maxActive += 2;

    if (window.playerData.build_2) maxActive += 7;

    let maxPassive = 0;
    if (window.playerData.professions[1]) maxPassive += 1;
    if (window.playerData.professions[2]) maxPassive += 1;
    if (window.playerData.professions[3]) maxPassive += 3;

    if (window.playerData.build_2) maxPassive += 5;

    let currentActive = 0;
    let currentPassive = 0;
    const skillObj = window.skillDB[className][skillIdx];
    const isPassive = skillObj.category === "–ü–∞—Å—Å–∏–≤–Ω—ã–µ";

    for (const [sName, runes] of Object.entries(window.playerData.learnedSkills)) {
        const s = window.skillDB[className].find(sk => sk.name === sName);
        if (s) {
            if (s.category === "–ü–∞—Å—Å–∏–≤–Ω—ã–µ") currentPassive++;
            else currentActive++;
        }
    }

    if (!window.playerData.learnedSkills[skillName]) {
        if (isPassive && currentPassive >= maxPassive) {
            window.showCustomAlert(`‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –ø–∞—Å—Å–∏–≤–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤ (${currentPassive}/${maxPassive}).`);
            return;
        }
        if (!isPassive && currentActive >= maxActive) {
            window.showCustomAlert(`‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤ (${currentActive}/${maxActive}).`);
            return;
        }
    }

    if (isNaN(cost) || cost < 0) { 
        window.showCustomAlert("‚ö†Ô∏è –°—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞–≤—ã–∫–∞ –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞.");
        return;
    }
    
    if (window.playerData.runes >= cost) {
        window.showCustomConfirm(
            `–ò–∑—É—á–∏—Ç—å "${skillName} (${runeName})" –∑–∞ <span style="color:#fff">${cost}</span> üìñ?<br><br>–£ –≤–∞—Å –æ—Å—Ç–∞–Ω–µ—Ç—Å—è: ${(window.playerData.runes - cost).toFixed(1)} üìñ`,
            () => {
                window.playerData.runes = parseFloat((window.playerData.runes - cost).toFixed(1));
                
                if (!window.playerData.learnedSkills[skillName]) {
                    window.playerData.learnedSkills[skillName] = [];
                    if (!window.playerData.learnedSkillsOrder) window.playerData.learnedSkillsOrder = [];
                    window.playerData.learnedSkillsOrder.push(skillName);
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–±—ã—Ç—ã—Ö —Ä—É–Ω
                    if (window.playerData.forgottenSkillRunes && window.playerData.forgottenSkillRunes[skillName]) {
                        const restored = window.playerData.forgottenSkillRunes[skillName];
                        window.playerData.learnedSkills[skillName] = [...restored];
                        delete window.playerData.forgottenSkillRunes[skillName];
                        window.showCustomAlert(`‚úÖ –ü–∞–º—è—Ç—å –≤–µ—Ä–Ω—É–ª–∞—Å—å! –í—Å–µ —Ä—É–Ω—ã –Ω–∞–≤—ã–∫–∞ "${skillName}" –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.`);
                    }
                }
                if (!window.playerData.learnedSkills[skillName].includes(runeName)) {
                    window.playerData.learnedSkills[skillName].push(runeName);
                }

                window.saveToStorage();
                window.logEvent(`–ò–∑—É—á–µ–Ω –Ω–∞–≤—ã–∫: ${skillName} (${runeName})`, 'info');
                window.updateUI();
                window.showCustomAlert("‚úÖ –ù–∞–≤—ã–∫ —É—Å–ø–µ—à–Ω–æ –∏–∑—É—á–µ–Ω!");
                
                const buyBtn = document.querySelector('.buy-skill-btn');
                buyBtn.innerText = "–ò–ó–£–ß–ï–ù–û";
                buyBtn.disabled = true;
                buyBtn.style.background = "#333";
                buyBtn.style.color = "#aaa";
                buyBtn.style.border = "1px solid #555";
                 // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ä–µ–≤–æ, —á—Ç–æ–±—ã –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∏–∑—É—á–µ–Ω–Ω—ã–π –Ω–∞–≤—ã–∫
                window.initSkillTree(className);
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                const nodes = document.querySelectorAll('.skill-node');
                nodes.forEach(n => {
                    if (n.innerText === skillName[0] && n.title === skillName) n.classList.add('active');
                });
            }
        );
    } else {
        window.showCustomAlert(`‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä—É–Ω!<br><br>–ù—É–∂–Ω–æ: <span style="color:#ff4444">${cost}</span> üìñ<br>–£ –≤–∞—Å: <span style="color:#66ccff">${window.playerData.runes}</span> üìñ`);
    }
}

// --- –§–£–ù–ö–¶–ò–ò –†–ï–î–ê–ö–¢–û–†–ê –î–ï–†–ï–í–ê ---

window.toggleSkillTreeEditor = function() {
    window.isSkillTreeEditing = !window.isSkillTreeEditing;
    const controls = document.getElementById('editor-controls');
    if (controls) controls.style.display = window.isSkillTreeEditing ? 'block' : 'none';
    
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–µ—Ä–µ–≤–æ, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å/—É–±—Ä–∞—Ç—å –¥—Ä–∞–≥-–Ω-–¥—Ä–æ–ø
    const cls = window.skillTreeState.currentClass;
    if (cls) window.initSkillTree(cls);
}

window.makeNodeDraggable = function(node) {
    let startX, startY, initialLeft, initialTop;

    node.onmousedown = function(e) {
        e.preventDefault();
        e.stopPropagation(); // –ß—Ç–æ–±—ã –Ω–µ –¥–≤–∏–≥–∞—Ç—å –≤—Å—é –∫–∞—Ä—Ç—É

        startX = e.clientX;
        startY = e.clientY;
        initialLeft = parseFloat(node.style.left) || 0;
        initialTop = parseFloat(node.style.top) || 0;

        document.onmousemove = function(e) {
            e.preventDefault();
            // –£—á–∏—Ç—ã–≤–∞–µ–º –º–∞—Å—à—Ç–∞–± (zoom) –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏
            const scale = window.skillTreeState.scale || 1;
            const dx = (e.clientX - startX) / scale;
            const dy = (e.clientY - startY) / scale;

            node.style.left = (initialLeft + dx) + "px";
            node.style.top = (initialTop + dy) + "px";
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –ª–∏–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (—Å–ª–æ–∂–Ω–æ, –ø–æ–∫–∞ –ø—Ä–æ–ø—É—Å—Ç–∏–º –∏–ª–∏ —Å–¥–µ–ª–∞–µ–º –ø–æ–∑–∂–µ)
            // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ª–∏–Ω–∏–∏ –æ–±–Ω–æ–≤—è—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–µ –¥–µ—Ä–µ–≤–∞ (–ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)
        };

        document.onmouseup = function() {
            document.onmousemove = null;
            document.onmouseup = null;
        };
    };
    
    // –í–∏–∑—É–∞–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –º–æ–∂–Ω–æ —Ç–∞—â–∏—Ç—å
    node.style.cursor = "move";
    node.style.border = "2px dashed #fff";
}

window.saveTreeLayout = function() {
    const cls = window.skillTreeState.currentClass;
    if (!cls) return;

    const nodes = document.querySelectorAll('.skill-node');
    const layout = {};

    nodes.forEach(node => {
        const name = node.dataset.skillName;
        if (name) {
            layout[name] = {
                x: parseFloat(node.style.left),
                y: parseFloat(node.style.top)
            };
        }
    });

    if (!window.customSkillLayouts) window.customSkillLayouts = {};
    window.customSkillLayouts[cls] = layout;
    
    localStorage.setItem('d3mod_skill_layouts', JSON.stringify(window.customSkillLayouts));
    window.showCustomAlert("‚úÖ –†–∞—Å–∫–ª–∞–¥–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ!");
    
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –ª–∏–Ω–∏–∏
    window.initSkillTree(cls);
}

window.exportTreeLayout = function() {
    const cls = window.skillTreeState.currentClass;
    if (!cls || !window.customSkillLayouts[cls]) {
        window.showCustomAlert("–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ä–∞—Å–∫–ª–∞–¥–∫—É.");
        return;
    }
    
    const json = JSON.stringify(window.customSkillLayouts[cls], null, 2);
    console.log(json);
    window.showCustomPrompt("–≠–∫—Å–ø–æ—Ä—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç", "–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç JSON –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É:", json, () => {}, true);
}

window.clearTreeLayout = function() {
    const cls = window.skillTreeState.currentClass;
    if (!cls) return;
    
    if (window.customSkillLayouts[cls]) {
        delete window.customSkillLayouts[cls];
        localStorage.setItem('d3mod_skill_layouts', JSON.stringify(window.customSkillLayouts));
        window.showCustomAlert("üóëÔ∏è –†–∞—Å–∫–ª–∞–¥–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é.");
        window.initSkillTree(cls);
    }
}
